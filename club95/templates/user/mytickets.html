{% extends "base.html" %} {% from "partials/search_filters.html" import
render_search_filters %} {% block body %} {{ render_search_filters(
search_term|default(''), 'user_bp.mytickets', filter_event_types, filter_genres,
filter_statuses ) }}

<div class="main-window">
    <section class="my-tickets-page">
        <div class="container" id="my-tickets-page-container">
            {% if orders %}
            <div class="row justify-content-center gy-4">
                {% for order in orders %}
                    {% set first_item = order.visible_items[0] if order.visible_items else None %}
                    {% set ticket = first_item.ticket if first_item else None %}
                    {% set event = ticket.event if ticket else None %}
                <div class="col-sm-12 col-md-6 col-lg-4">
                    <div class="window" id="order-{{ order.id }}">
                        <div class="title-bar">
                            <span class="window-title">
                                {% if event and event.title %}
                                    {{ event.title }} – Order #{{ order.id }}
                                {% else %}
                                    Order #{{ order.id }}
                                {% endif %}
                            </span>
                            <div class="window-controls">
                                <button type="button" class="btn">_</button>
                                <button type="button" class="btn">☐</button>
                                <button type="button" class="btn" id="closebtn">X</button>
                            </div>
                        </div>
                        <div class="sub-window">
                            {% set poster_src = url_for('static', filename='img/' ~ event.image) if event and event.image else url_for('static', filename='img/crescent-city-players-poster-horizontal.jpg') %}
                            <img
                                src="{{ poster_src }}"
                                class="window-img-top img-fit"
                                alt="{{ event.title if event else 'Event poster' }}"
                            />
                            <section class="window-tags">
                                {% set event_type_label = event.event_type.typeName if event and event.event_type else 'Event' %}
                                <span class="badge" id="event-type">{{ event_type_label }}</span>
                                {% set status_label = event.status if event and event.status else 'OPEN' %}
                                <span class="badge" id="event-status-{{ status_label|lower|replace(' ', '-') }}">{{ status_label }}</span>
                            </section>
                            <p class="sub-window-content">
                                <strong>> ORDER DATE:</strong>
                                {{ order.order_date.strftime('%b %d, %Y') if order.order_date else 'Pending' }}
                                <br />
                                <strong>> PURCHASED TICKET(s):</strong>
                                <br />
                                {% for line_item in order.visible_items %}
                                    {{ line_item.quantity }}x {{ line_item.ticket.ticketTier }} – ${{ '%.2f'|format(line_item.price_at_purchase) }}
                                    <br />
                                {% endfor %}
                                <br />
                                <strong>> DESCRIPTION:</strong>
                                {{ event.description if event and event.description else 'No description available.' }}
                                <br /><br />
                                <strong>> ARTIST LINEUP:</strong>
                                {% if event and event.artist_links %}
                                    {% for link in event.artist_links %}
                                        {{ link.artist.artistName }}{% if link.set_time %} ({{ link.set_time }}){% endif %}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% elif event and event.artists %}
                                    {% for artist in event.artists %}
                                        {{ artist.artistName }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Not available
                                {% endif %}
                                <br />
                                <strong>> VENUE:</strong>
                                {{ event.venue.location if event and event.venue else 'TBA' }}
                                <br />
                                <strong>> DATE:</strong>
                                {{ event.date if event and event.date else 'TBA' }}
                                <br />
                                <strong>> TIME:</strong>
                                {% if event and event.start_time %}
                                    {{ event.start_time }}{% if event.end_time %}-{{ event.end_time }}{% endif %}
                                {% else %}
                                    TBA
                                {% endif %}
                                <br />
                                <strong>> GENRES:</strong>
                                {% if event and event.genres %}
                                    {% for genre in event.genres %}
                                        <a class="genre-search-link" href="{{ url_for('user_bp.mytickets', search=genre.genreType) }}">{{ genre.genreType }}</a>{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span>N/A</span>
                                {% endif %}
                            </p>
                            <button
                                class="btn"
                                id="view-details-btn"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#order-details-{{ order.id }}"
                                aria-expanded="false"
                                aria-controls="order-details-{{ order.id }}"
                            >
                                View Ticket
                            </button>
                            <div class="collapse ticket-details mt-3" id="order-details-{{ order.id }}">
                                <div class="sub-window ticket-summary">
                                    <p class="sub-window-content">
                                        <strong>Booking confirmed!</strong>
                                        <br />
                                        Your order reference is <strong>#{{ order.id }}</strong>.
                                        <br />
                                        Please have this confirmation ready when you arrive.
                                        <br />
                                        <br />
                                        <strong>Booked on:</strong>
                                        {{ order.order_date.strftime('%A, %d %B %Y %I:%M %p') if order.order_date else 'Pending confirmation' }}
                                        <br />
                                        <strong>Total paid:</strong>
                                        ${{ '%.2f'|format(order.amount) if order.amount is not none else 'TBA' }}
                                    </p>
                                    {% for line_item in order.visible_items %}
                                        {% set line_ticket = line_item.ticket %}
                                        {% set line_event = line_ticket.event if line_ticket else None %}
                                        <div class="ticket-item mb-3">
                                            <p class="sub-window-content">
                                                <strong>{{ line_event.title if line_event and line_event.title else 'Event' }}</strong>
                                                <br />
                                                <strong>Ticket tier:</strong> {{ line_ticket.ticketTier if line_ticket else 'TBA' }}
                                                <br />
                                                <strong>Quantity:</strong> {{ line_item.quantity }}
                                                <br />
                                                <strong>Entry price:</strong> ${{ '%.2f'|format(line_item.price_at_purchase) }}
                                                <br />
                                                <strong>Venue:</strong> {{ line_event.venue.location if line_event and line_event.venue else 'TBA' }}
                                                <br />
                                                <strong>Date:</strong> {{ line_event.date if line_event and line_event.date else 'TBA' }}
                                                <br />
                                                <strong>Time:</strong>
                                                {% if line_event and line_event.start_time %}
                                                    {{ line_event.start_time }}{% if line_event.end_time %}-{{ line_event.end_time }}{% endif %}
                                                {% else %}
                                                    TBA
                                                {% endif %}
                                                <br />
                                                <strong>Need to check event info?</strong>
                                                <a class="genre-search-link" href="{{ url_for('events_bp.eventdetails', event_id=line_event.id) if line_event else '#!' }}">View event page</a>
                                            </p>
                                        </div>
                                    {% endfor %}
                                    <p class="sub-window-content mb-0">
                                        We look forward to seeing you there! If you have any questions, contact the organiser with your order reference.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="row justify-content-center">
                <div class="col-sm-12 col-md-6 col-lg-4">
                    <div class="window" id="no-orders-window">
                        <div class="title-bar">
                            <span class="window-title">No Orders Yet</span>
                            <div class="window-controls">
                                <button type="button" class="btn">_</button>
                                <button type="button" class="btn">☐</button>
                                <button type="button" class="btn" id="closebtn">X</button>
                            </div>
                        </div>
                        <div class="sub-window">
                            <p class="sub-window-content">
                                Purchase tickets to see them listed here.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}
