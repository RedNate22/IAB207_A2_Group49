{% extends "base.html" %} {% block body %}
<div class="main-window">
    <form
        id="add-genre-form"
        method="POST"
        action="{{ url_for('events_bp.add_genre') }}"
    >
        {{ add_genre_form.hidden_tag() }}
    </form>
    <form id="create-event-form" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <!-- Create Event Section -->
        <section class="create-event-page">
            <div class="container" id="create-event-page-container">
                <!-- Enter Event Name Section -->
                <section class="enter-event-name-section">
                    <div class="row align-items-center">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div class="window" id="enter-event-name-window">
                                <div class="title-bar">
                                    <span class="window-title">Event Name</span>
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <!-- prettier-ignore -->
                                    {{ form.title(class="form-control form-control-lg", placeholder="Enter the name of the event") }}
                                    {% if form.title.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.title.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-3"></div>
                </section>
                <!-- End of Enter Event Name Section -->

                <!-- Enter Event Description Section -->
                <section class="enter-event-description-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div
                                class="window"
                                id="enter-event-description-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Description</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <div class="mb-3" id="post-comment-form">
                                        <label
                                            for="description-text"
                                            class="enter-comment"
                                            >Enter description:</label
                                        >
                                        {{ form.description(class="form-control", id="description-text", rows="6") }}
                                        {% if form.description.errors %}
                                        <div class="alert alert-danger mt-2">
                                            {% for error in form.description.errors %}{{ error }}<br>{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div
                                        id="description-help"
                                        class="form-text"
                                    >
                                        Your description must be at least 20
                                        words long.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Description Section -->

                <!-- Upload Event Poster Section -->
                <section class="upload-event-poster-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div class="window" id="upload-event-poster-window">
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Event Poster</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <label for="formFile" class="form-label"
                                        >Upload a poster for your event.</label
                                    >
                                    {{ form.image(class="form-control",
                                    id="formFile") }}
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Upload Event Poster Section -->

                <!-- Enter Event Location Section -->
                <section class="enter-event-location-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div
                                class="window"
                                id="enter-event-location-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title">Location</span>
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <!-- prettier-ignore -->
                                    {{ form.location(class="form-control", placeholder="Enter the location of the event") }}
                                    {% if form.location.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.location.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Location Section -->

                <section class="enter-event-date-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div class="window" id="enter-event-date-window">
                                <div class="title-bar">
                                    <span class="window-title">Date</span>
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                                {{ form.date(class="form-control", type="date", placeholder="Enter date") }}
                                    {% if form.date.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.date.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Date Section -->

                <!-- Enter Event Start End Time Section -->
                <section class="enter-event-start-end-time-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-3">
                            <div
                                class="window"
                                id="enter-event-start-time-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Event Start Time</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    {{ form.start_time(class="form-control", type="time", step="60") }}
                                    {% if form.start_time.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.start_time.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div
                                class="window"
                                id="enter-event-end-time-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Event End Time</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    {{ form.end_time(class="form-control", type="time", step="60") }}
                                    {% if form.end_time.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.end_time.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Event Enter Start End Time Section -->

                <!-- Enter Event Type Section -->
                <section class="enter-event-type-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div class="window" id="enter-event-type-window">
                                <div class="title-bar">
                                    <span class="window-title">Event Type</span>
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    {{ form.type(class="form-control") }}
                                    {% if form.type.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.type.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Type Section -->

                <!-- Enter Event Genres section -->
                <section class="enter-event-genres-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div
                            class="col-6 d-flex align-items-start"
                            style="gap: 12px"
                        >
                            <div
                                class="btn-group"
                                id="enter-event-genres-btn-group"
                            >
                                <button
                                    class="btn dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="enter-event-genres-btn"
                                >
                                    Select Genres For Event
                                </button>
                                <ul
                                    class="dropdown-menu dropdown-menu-end"
                                    id="dropdown-menu"
                                >
                                    {% for id, name in form.genres.choices %}
                                    <li class="d-flex align-items-center">
                                        <input
                                            class="form-check-input mt-0 ms-2"
                                            type="checkbox"
                                            name="genres"
                                            value="{{ id }}"
                                            id="genre-{{ id }}"
                                            {%
                                            if
                                            id
                                            in
                                            (form.genres.data
                                            or
                                            [])
                                            %}checked{%
                                            endif
                                            %}
                                        />
                                        <span class="dropdown-text">
                                            {{ name }}
                                        </span>
                                    </li>
                                    {% endfor %}
                                    {% if form.genres.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.genres.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                    {% endif %}
                                </ul>
                            </div>
                            <div
                                class="d-flex align-items-center"
                                style="gap: 8px"
                            >
                                {{
                                add_genre_form.new_genre(class="form-control",
                                id="new-genre", placeholder="Add new genre",
                                form="add-genre-form") }} {{
                                add_genre_form.selected_genres(
                                    id="selected-genres-field",
                                    type="hidden",
                                    form="add-genre-form"
                                ) }} {{
                                add_genre_form.submit(class="btn btn-secondary",
                                form="add-genre-form") }}
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>

                <!-- End of Enter Event Genres section -->

                <!-- Enter Event Artist Lineup Section -->
                <section class="artist-lineup-section">
                    <div id="artist-lineup-rows">
                        <div class="row align-items-start artist-row">
                            <div class="col-3"></div>
                            <div class="col-3">
                                <div
                                    class="window"
                                    id="enter-artist-name-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title"
                                            >Artist Name</span
                                        >
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="text"
                                            placeholder="Enter artist name"
                                            name="artist_name[]"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div
                                    class="window"
                                    id="enter-artist-set-time-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title"
                                            >Set Time</span
                                        >
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="text"
                                            placeholder="Enter set start time in 24hr (hh:mm)"
                                            name="artist_set_time[]"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-3"></div>
                        </div>
                    </div>
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div
                                class="btn-group"
                                id="add-more-artists-btn-group"
                            >
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    id="add-more-artists-btn"
                                >
                                    Add more artists...
                                </button>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Artist Lineup Section -->

                <!-- Enter Ticket Tiers Section -->
                <section class="ticket-tiers-section">
                    <div id="ticket-tiers-rows">
                        <div class="row align-items-start ticket-row">
                            <div class="col-3"></div>
                            <div class="col-6">
                                <div
                                    class="window"
                                    id="enter-ticket-tier-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title"
                                            >Ticket Tier</span
                                        >
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="text"
                                            name="ticket_tier[]"
                                            placeholder="Enter Ticket Tier"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row align-items-start ticket-row">
                            <div class="col-3"></div>
                            <div class="col-3">
                                <div
                                    class="window"
                                    id="enter-ticket-price-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title">Price</span>
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="text"
                                            name="ticket_price[]"
                                            placeholder="Enter Ticket Price ($)"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div
                                    class="window"
                                    id="enter-ticket-quantity-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title"
                                            >Quantity</span
                                        >
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="text"
                                            name="ticket_quantity[]"
                                            placeholder="Enter Ticket Quantity"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-3"></div>
                        </div>
                    </div>
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div
                                class="btn-group"
                                id="add-more-ticket-tiers-btn-group"
                            >
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    id="add-more-ticket-tiers-btn"
                                >
                                    Add More Ticket Tiers...
                                </button>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Ticket Tiers Section -->

                <!-- Upload Additional Media Section -->
                <section class="upload-additional-media-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div
                                class="window"
                                id="upload-additional-media-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Additional Media</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <label
                                        for="formFileMultiple"
                                        class="form-label"
                                        >(Optional) Upload additional media for
                                        your event.</label
                                    >
                                    <input
                                        class="form-control"
                                        type="file"
                                        id="formFileMultiple"
                                        name="additional_media"
                                        multiple
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Upload Additional Media Section -->

                <!-- Post Event Section -->
                <section class="post-event-section">
                    <div class="row align-items-start">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div class="btn-group" id="post-event-btn-group">
                                {{ form.submit(class="btn btn-primary",
                                id="post-event-btn") }}
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                </section>
                <!-- End of Post Event Section -->
            </div>
        </section>
        <!-- End of Create Event Section -->
    </form>
</div>

<!-- prettier-ignore -->
<script>
    // Create event form state management
    document.addEventListener("DOMContentLoaded", () => {
        const STORAGE_KEY = "createEventFormState";
        const createForm = document.getElementById("create-event-form");
        const addGenreForm = document.getElementById("add-genre-form");
        const selectedGenresField = document.getElementById(
            "selected-genres-field"
        );
        const genreCheckboxSelector =
            "#enter-event-genres-btn-group input[type='checkbox']";

        const artistRows = document.getElementById("artist-lineup-rows");
        const ticketRows = document.getElementById("ticket-tiers-rows");
        const addMoreArtistsBtn = document.getElementById(
            "add-more-artists-btn"
        );
        const addMoreTicketBtn = document.getElementById(
            "add-more-ticket-tiers-btn"
        );

        const cloneTemplateRow = (template) => {
            const clone = template.cloneNode(true);
            clone.querySelectorAll("input").forEach((input) => {
                input.value = "";
            });
            return clone;
        };

        const ensureRowCount = (container, desiredCount) => {
            if (!container || !container.children.length) {
                return;
            }
            const template = container.children[0];
            const target = Math.max(desiredCount, 1);
            while (container.children.length < target) {
                container.appendChild(cloneTemplateRow(template));
            }
        };

        const collectFormState = () => {
            if (!createForm) {
                return null;
            }
            const state = {};
            const assignIfExists = (name) => {
                const field = createForm.querySelector(`[name="${name}"]`);
                state[name] = field ? field.value : "";
            };

            [
                "title",
                "date",
                "description",
                "location",
                "start_time",
                "end_time",
                "type",
                "user_id",
            ].forEach(assignIfExists);

            state.genres = Array.from(
                document.querySelectorAll(genreCheckboxSelector)
            )
                .filter((checkbox) => checkbox.checked)
                .map((checkbox) => parseInt(checkbox.value, 10));

            state.artist_name = Array.from(
                document.querySelectorAll('input[name="artist_name[]"]')
            ).map((input) => input.value);

            state.artist_set_time = Array.from(
                document.querySelectorAll('input[name="artist_set_time[]"]')
            ).map((input) => input.value);

            state.ticket_tier = Array.from(
                document.querySelectorAll('input[name="ticket_tier[]"]')
            ).map((input) => input.value);

            state.ticket_price = Array.from(
                document.querySelectorAll('input[name="ticket_price[]"]')
            ).map((input) => input.value);

            state.ticket_quantity = Array.from(
                document.querySelectorAll('input[name="ticket_quantity[]"]')
            ).map((input) => input.value);

            return state;
        };

        const saveState = () => {
            const state = collectFormState();
            // Save the current form state to localStorage
            if (state) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }
        };

        // Restore the form state from localStorage if available
        const restoreState = () => {
            if (!createForm) {
                return;
            }
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                return;
            }
            let state;
            try {
                state = JSON.parse(raw);
            } catch (error) {
                return;
            }
            // Helper to set field value if it exists in the form
            const setIfExists = (name, value) => {
                const field = createForm.querySelector(`[name="${name}"]`);
                if (field && typeof value !== "undefined") {
                    field.value = value;
                }
            };

            // Restore basic fields
            [
                "title",
                "date",
                "description",
                "location",
                "start_time",
                "end_time",
                "type",
                "user_id",
            ].forEach((name) => setIfExists(name, state[name]));

            // Restore genre selections
            if (Array.isArray(state.genres)) {
                const selected = state.genres.map((value) => parseInt(value, 10));
                document.querySelectorAll(genreCheckboxSelector).forEach(
                    (checkbox) => {
                        checkbox.checked = selected.includes(
                            parseInt(checkbox.value, 10)
                        );
                    }
                );
            }

            // Restore artist rows and their values
            if (Array.isArray(state.artist_name) && artistRows) {
                ensureRowCount(artistRows, state.artist_name.length);
                Array.from(
                    document.querySelectorAll('input[name="artist_name[]"]')
                ).forEach((input, index) => {
                    input.value = state.artist_name[index] || "";
                });
            }

            // Restore artist set times
            if (Array.isArray(state.artist_set_time)) {
                Array.from(
                    document.querySelectorAll('input[name="artist_set_time[]"]')
                ).forEach((input, index) => {
                    input.value = state.artist_set_time[index] || "";
                });
            }

            // Restore ticket rows and their values
            if (Array.isArray(state.ticket_tier) && ticketRows) {
                ensureRowCount(ticketRows, state.ticket_tier.length);
                Array.from(
                    document.querySelectorAll('input[name="ticket_tier[]"]')
                ).forEach((input, index) => {
                    input.value = state.ticket_tier[index] || "";
                });
            }

            // Restore ticket prices
            if (Array.isArray(state.ticket_price)) {
                Array.from(
                    document.querySelectorAll('input[name="ticket_price[]"]')
                ).forEach((input, index) => {
                    input.value = state.ticket_price[index] || "";
                });
            }

            // Restore ticket quantities
            if (Array.isArray(state.ticket_quantity)) {
                Array.from(
                    document.querySelectorAll('input[name="ticket_quantity[]"]')
                ).forEach((input, index) => {
                    input.value = state.ticket_quantity[index] || "";
                });
            }
        };

    // On page load, restore any saved form state
    restoreState();

        // Save form state on any input or change, clear on submit
        if (createForm) {
            createForm.addEventListener("input", saveState);
            createForm.addEventListener("change", saveState);
            createForm.addEventListener("submit", () => {
                localStorage.removeItem(STORAGE_KEY);
            });
        }

        // Add new artist row and save state
        if (addMoreArtistsBtn && artistRows) {
            addMoreArtistsBtn.addEventListener("click", function () {
                artistRows.appendChild(
                    cloneTemplateRow(artistRows.children[0])
                );
                saveState();
            });
        }

        // Add new ticket row and save state
        if (addMoreTicketBtn && ticketRows) {
            addMoreTicketBtn.addEventListener("click", function () {
                ticketRows.appendChild(
                    cloneTemplateRow(ticketRows.children[0])
                );
                saveState();
            });
        }

        // On genre form submit, update hidden field and save state
        if (addGenreForm && selectedGenresField) {
            addGenreForm.addEventListener("submit", () => {
                const checkedValues = Array.from(
                    document.querySelectorAll(genreCheckboxSelector)
                )
                    .filter((checkbox) => checkbox.checked)
                    .map((checkbox) => checkbox.value);
                selectedGenresField.value = checkedValues.join(",");
                saveState();
            });
        }
    });
</script>
{% endblock %}
