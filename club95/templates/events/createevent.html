{% extends "base.html" %} {% block body %}
<div class="main-window">
    <form
        id="add-genre-form"
        method="POST"
        action="{{ url_for('events_bp.add_genre') }}"
    >
        {{ add_genre_form.hidden_tag() }}
    </form>
    <form id="create-event-form" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <!-- Create Event Section -->
        <section class="create-event-page">
            <div class="container" id="create-event-page-container">
                <!-- Enter Event Name Section -->
                <section class="enter-event-name-section">
                    <div class="row align-items-center">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div class="window" id="enter-event-name-window">
                                <div class="title-bar">
                                    <span class="window-title">Event Name</span>
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <!-- prettier-ignore -->
                                    {{ form.title(class="form-control form-control-lg", placeholder="Enter the name of the event") }}
                                    {% if form.title.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.title.errors %}{{
                                        error }}<br />{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Name Section -->

                <!-- Enter Event Description Section -->
                <section class="enter-event-description-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div
                                class="window"
                                id="enter-event-description-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Description</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <div class="mb-3" id="post-comment-form">
                                        <label
                                            for="description-text"
                                            class="enter-comment"
                                            >Enter description:</label
                                        >
                                        {{
                                        form.description(class="form-control",
                                        id="description-text", rows="6") }} {%
                                        if form.description.errors %}
                                        <div class="alert alert-danger mt-2">
                                            {% for error in
                                            form.description.errors %}{{ error
                                            }}<br />{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div
                                        id="description-help"
                                        class="form-text"
                                    >
                                        Your description must be at least 20
                                        words long.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Description Section -->

                <!-- Upload Event Poster Section -->
                <section class="upload-event-poster-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div class="window" id="upload-event-poster-window">
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Event Poster</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <label for="formFile" class="form-label"
                                        >Upload a poster for your event.</label
                                    >
                                    {{ form.image(class="form-control",
                                    id="formFile") }}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Upload Event Poster Section -->

                <!-- Enter Event Location Section -->
                <section class="enter-event-location-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div
                                class="window"
                                id="enter-event-location-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title">Location</span>
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <!-- prettier-ignore -->
                                    {{ form.location(class="form-control", placeholder="Enter the location of the event") }}
                                    {% if form.location.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.location.errors
                                        %}{{ error }}<br />{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Location Section -->

                <section class="enter-event-date-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div class="window" id="enter-event-date-window">
                                <div class="title-bar">
                                    <span class="window-title">Date</span>
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    {{ form.date(class="form-control",
                                    type="date", placeholder="Enter date",
                                    min=min_date) }} {% if form.date.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.date.errors %}{{
                                        error }}<br />{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Date Section -->

                <!-- Enter Event Start End Time Section -->
                <section class="enter-event-start-end-time-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-4 col-lg-3">
                            <div
                                class="window"
                                id="enter-event-start-time-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Event Start Time</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    {{ form.start_time(class="form-control",
                                    type="time", step="60", min="00:00",
                                    max="23:59", title="Use 24hr format hh:mm")
                                    }} {% if form.start_time.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.start_time.errors
                                        %}{{ error }}<br />{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-3">
                            <div
                                class="window"
                                id="enter-event-end-time-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Event End Time</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    {{ form.end_time(class="form-control",
                                    type="time", step="60", min="00:00",
                                    max="23:59", title="Use 24hr format hh:mm")
                                    }} {% if form.end_time.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.end_time.errors
                                        %}{{ error }}<br />{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Event Enter Start End Time Section -->

                <!-- Enter Event Type Section -->
                <section class="enter-event-type-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <!-- prettier-ignore -->
                            <div class="sub-window">
                                {{ form.type(class="form-control event-type-field") }} 
                                {% if form.type.errors %}
                                <div class="alert alert-danger mt-2"></div>
                                    {% for error in form.type.errors %} 
                                        {{ error }}
                                    <br />
                                    {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-sm-0 col-md-2 col-lg-3"></div>
                </section>
                <!-- End of Enter Event Type Section -->

                <!-- Enter Event Genres section -->
                <section class="enter-event-genres-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div
                                class="btn-group"
                                id="enter-event-genres-btn-group"
                            >
                                <button
                                    class="btn dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="enter-event-genres-btn"
                                >
                                    Select Genres For Event
                                </button>
                                <!-- prettier-ignore -->
                                <ul
                                    class="dropdown-menu dropdown-menu-end"
                                    id="dropdown-menu"
                                >
                                    {% for id, name in form.genres.choices %}
                                    <li class="align-items-center">
                                        <input
                                            class="form-check-input mt-0 ms-2"
                                            type="checkbox"
                                            name="genres"
                                            value="{{ id }}"
                                            id="genre-{{ id }}"
                                            {% if id in (form.genres.data or []) %} 
                                                checked 
                                            {% endif %}
                                        />
                                        <span class="dropdown-text">
                                            {{ name }}
                                        </span>
                                    </li>
                                    {% endfor %} 
                                    {% if form.genres.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.genres.errors %}
                                            {{ error }} <br />
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-4 col-lg-4">
                            <!-- prettier-ignore -->
                            {{ add_genre_form.new_genre(
                                    class="form-control", 
                                    id="new-genre",
                                    placeholder="Add new genre...",
                                    form="add-genre-form") 
                                }}
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-2">
                            <!-- prettier-ignore -->
                            {{ add_genre_form.selected_genres(
                                    id="selected-genres-field",
                                    type="hidden", 
                                    form="add-genre-form" )
                            }} 
                            {{ add_genre_form.submit( 
                                class="btn w-100 add-genre-confirm-btn", 
                                form="add-genre-form")
                            }}
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Enter Event Genres section -->

                <!-- Enter Event Artist Lineup Section -->
                <section class="artist-lineup-section">
                    <div id="artist-lineup-rows">
                        <div class="row align-items-start artist-row">
                            <div class="col-sm-0 col-md-2 col-lg-3"></div>
                            <div class="col-sm-12 col-md-4 col-lg-3">
                                <div
                                    class="window"
                                    id="enter-artist-name-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title"
                                            >Artist Name</span
                                        >
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="text"
                                            placeholder="Enter artist name"
                                            name="artist_name[]"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 col-md-4 col-lg-3">
                                <div
                                    class="window"
                                    id="enter-artist-set-time-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title"
                                            >Set Time</span
                                        >
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="time"
                                            step="60"
                                            min="00:00"
                                            max="23:59"
                                            title="Use 24hr format hh:mm"
                                            placeholder="Enter set start time"
                                            name="artist_set_time[]"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        </div>
                    </div>
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div
                                class="btn-group"
                                id="add-more-artists-btn-group"
                            >
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    id="add-more-artists-btn"
                                >
                                    Add more artists...
                                </button>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                    {% if artist_errors %}
                    <div class="row mt-2">
                        <div class="col-3"></div>
                        <div class="col-6">
                            <div class="alert alert-danger">
                                {% for error in artist_errors %}{{ error }}<br />{%
                                endfor %}
                            </div>
                        </div>
                        <div class="col-2"></div>
                    </div>
                    {% endif %}
                </section>
                <!-- End of Artist Lineup Section -->

                <!-- Enter Ticket Tiers Section -->
                <section class="ticket-tiers-section">
                    <div id="ticket-tiers-rows">
                        <div class="row align-items-start ticket-row">
                            <div class="col-sm-0 col-md-2 col-lg-3"></div>
                            <div class="col-sm-12 col-md-8 col-lg-6">
                                <div
                                    class="window"
                                    id="enter-ticket-tier-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title"
                                            >Ticket Tier</span
                                        >
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="text"
                                            name="ticket_tier[]"
                                            placeholder="Enter Ticket Tier"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        </div>

                        <div class="row align-items-start ticket-row">
                            <div class="col-sm-0 col-md-2 col-lg-3"></div>
                            <div class="col-sm-12 col-md-4 col-lg-3">
                                <div
                                    class="window"
                                    id="enter-ticket-perks-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title">Perks</span>
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="text"
                                            name="ticket_perks[]"
                                            placeholder="Water, Wi-Fi, Pizza, etc."
                                            maxlength="50"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        </div>

                        <div class="row align-items-start ticket-row">
                            <div class="col-sm-0 col-md-2 col-lg-3"></div>
                            <div class="col-sm-12 col-md-4 col-lg-3">
                                <div
                                    class="window"
                                    id="enter-ticket-price-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title">Price</span>
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="decimal"
                                            name="ticket_price[]"
                                            placeholder="Enter Ticket Price ($)"
                                            min="0"
                                            step="0.01"
                                            inputmode="decimal"
                                            oninput="this.value = this.value.replace(/[^0-9.]/g, ''); const parts = this.value.split('.'); if (parts.length > 2) { this.value = parts[0] + '.' + parts.slice(1).join(''); }"
                                            onblur="if (this.value.includes('.')) { const [whole, fraction] = this.value.split('.'); this.value = fraction ? `${whole}.${fraction.slice(0,2)}` : whole; }"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 col-md-4 col-lg-3">
                                <div
                                    class="window"
                                    id="enter-ticket-quantity-window"
                                >
                                    <div class="title-bar">
                                        <span class="window-title"
                                            >Quantity</span
                                        >
                                        <div class="window-controls">
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                _
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                href="#!"
                                            >
                                                ☐
                                            </button>
                                            <button
                                                type="button"
                                                class="btn"
                                                id="closebtn"
                                                href="#!"
                                            >
                                                X
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sub-window">
                                        <input
                                            class="form-control"
                                            type="number"
                                            name="ticket_quantity[]"
                                            placeholder="Enter Ticket Quantity"
                                            min="1"
                                            step="1"
                                            inputmode="numeric"
                                            oninput="this.value = this.value.replace(/[^0-9]/g, '');"
                                            onblur="if (this.value === '' || parseInt(this.value) < 1) { this.value = 1; } else if (parseInt(this.value) > 150000) { this.value = 150000; }"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        </div>
                    </div>
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div
                                class="btn-group"
                                id="add-more-ticket-tiers-btn-group"
                            >
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    id="add-more-ticket-tiers-btn"
                                >
                                    Add More Ticket Tiers...
                                </button>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Ticket Tiers Section -->

                <!-- Upload Additional Media Section -->
                <section class="upload-additional-media-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div
                                class="window"
                                id="upload-additional-media-window"
                            >
                                <div class="title-bar">
                                    <span class="window-title"
                                        >Additional Media</span
                                    >
                                    <div class="window-controls">
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            _
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            href="#!"
                                        >
                                            ☐
                                        </button>
                                        <button
                                            type="button"
                                            class="btn"
                                            id="closebtn"
                                            href="#!"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                                <div class="sub-window">
                                    <label
                                        for="formFileMultiple"
                                        class="form-label"
                                        >(Optional) Upload additional media for
                                        your event.</label
                                    >
                                    <input
                                        class="form-control"
                                        type="file"
                                        id="formFileMultiple"
                                        name="additional_media"
                                        multiple
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Upload Additional Media Section -->

                <!-- Post Event Section -->
                <section class="post-event-section">
                    <div class="row align-items-start">
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                        <div class="col-sm-12 col-md-8 col-lg-6">
                            <div class="btn-group" id="post-event-btn-group">
                                {{ form.submit(class="btn btn-primary",
                                id="post-event-btn") }}
                            </div>
                        </div>
                        <div class="col-sm-0 col-md-2 col-lg-3"></div>
                    </div>
                </section>
                <!-- End of Post Event Section -->
            </div>
        </section>
        <!-- End of Create Event Section -->
    </form>
</div>

<!-- prettier-ignore -->
<script>
    // Everything here keeps the create event form tidy and remembers what I type
    document.addEventListener("DOMContentLoaded", () => {
    const STORAGE_KEY = "createEventFormState";
    const PRESERVE_KEY = "createEventFormPreserve";
    const prefilledGenres = JSON.parse('{{ prefilled_genres|tojson|safe }}');
        // Grab the bits of the page I need to poke later
        const createForm = document.getElementById("create-event-form");
        const addGenreForm = document.getElementById("add-genre-form");
        const selectedGenresField = document.getElementById(
            "selected-genres-field"
        );
        const genreCheckboxSelector =
            "#enter-event-genres-btn-group input[type='checkbox']";

        const artistRows = document.getElementById("artist-lineup-rows");
        const ticketRows = document.getElementById("ticket-tiers-rows");
        const addMoreArtistsBtn = document.getElementById(
            "add-more-artists-btn"
        );
        const addMoreTicketBtn = document.getElementById(
            "add-more-ticket-tiers-btn"
        );

        // Figure out if this is a fresh visit so I can bin any old draft
        const shouldClearState = () => {
            const preserveStateFlag = sessionStorage.getItem(PRESERVE_KEY);
            if (preserveStateFlag === "1") {
                sessionStorage.removeItem(PRESERVE_KEY);
                return false;
            }
            if (!window.performance) {
                return true;
            }
            if (performance.getEntriesByType) {
                const entries = performance.getEntriesByType("navigation");
                if (entries && entries.length) {
                    return entries[0].type === "navigate";
                }
            }
            if (performance.navigation) {
                const navType = performance.navigation.type;
                const { TYPE_NAVIGATE, TYPE_RELOAD, TYPE_BACK_FORWARD } =
                    performance.navigation;
                if (
                    navType === TYPE_RELOAD ||
                    navType === TYPE_BACK_FORWARD
                ) {
                    return false;
                }
                if (navType === TYPE_NAVIGATE) {
                    return true;
                }
            }
            return true;
        };

        if (shouldClearState()) {
            // Clean slate when I first open the page
            localStorage.removeItem(STORAGE_KEY);
        }

        // Makes a fresh copy of a row without any old values sticking around
        const cloneTemplateRow = (template) => {
            const clone = template.cloneNode(true);
            clone.querySelectorAll("input").forEach((input) => {
                input.value = "";
            });
            return clone;
        };

        // Keeps adding rows until we have the amount we need
        const ensureRowCount = (container, desiredCount) => {
            if (!container || !container.children.length) {
                return;
            }
            const template = container.children[0];
            const target = Math.max(desiredCount, 1);
            while (container.children.length < target) {
                container.appendChild(cloneTemplateRow(template));
            }
        };

        // Remember what each ticket tier block looks like so we can reuse it
        const ticketTemplates = ticketRows
            ? Array.from(ticketRows.querySelectorAll(".ticket-row"))
            : [];

        // Build a fresh ticket block with tier, perks, price, and quantity stuck together
        const createTicketBlock = () => {
            const fragment = document.createDocumentFragment();
            ticketTemplates.forEach((template) => {
                fragment.appendChild(cloneTemplateRow(template));
            });
            return fragment;
        };

        // Make sure we always have enough ticket blocks on the page
        const ensureTicketBlocks = (desiredCount) => {
            if (!ticketRows || !ticketTemplates.length) {
                return;
            }
            let currentCount = ticketRows.querySelectorAll(
                'input[name="ticket_tier[]"]'
            ).length;
            while (currentCount < desiredCount) {
                const fragment = createTicketBlock();
                if (!fragment.childNodes.length) {
                    break;
                }
                ticketRows.appendChild(fragment);
                currentCount += 1;
            }
        };

        // Gather everything from the form so I can stash it away
        const collectFormState = () => {
            if (!createForm) {
                return null;
            }
            const state = {};
            const assignIfExists = (name) => {
                const field = createForm.querySelector(`[name="${name}"]`);
                state[name] = field ? field.value : "";
            };

            [
                "title",
                "date",
                "description",
                "location",
                "start_time",
                "end_time",
                "type",
                "user_id",
            ].forEach(assignIfExists);

            state.genres = Array.from(
                document.querySelectorAll(genreCheckboxSelector)
            )
                .filter((checkbox) => checkbox.checked)
                .map((checkbox) => parseInt(checkbox.value, 10));

            state.artist_name = Array.from(
                document.querySelectorAll('input[name="artist_name[]"]')
            ).map((input) => input.value);

            state.artist_set_time = Array.from(
                document.querySelectorAll('input[name="artist_set_time[]"]')
            ).map((input) => input.value);

            state.ticket_tier = Array.from(
                document.querySelectorAll('input[name="ticket_tier[]"]')
            ).map((input) => input.value);

            state.ticket_price = Array.from(
                document.querySelectorAll('input[name="ticket_price[]"]')
            ).map((input) => input.value);

            state.ticket_quantity = Array.from(
                document.querySelectorAll('input[name="ticket_quantity[]"]')
            ).map((input) => input.value);

            state.ticket_perks = Array.from(
                document.querySelectorAll('input[name="ticket_perks[]"]')
            ).map((input) => input.value);

            return state;
        };

        // Store the current snapshot in localStorage
        const saveState = () => {
            const state = collectFormState();
            // Save the current form state to localStorage
            if (state) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }
        };

        // Pull saved values back into the form if I left and came back
        const restoreState = () => {
            if (!createForm) {
                return;
            }
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                return;
            }
            let state;
            try {
                state = JSON.parse(raw);
            } catch (error) {
                return;
            }
            // Helper to set field value if it exists in the form
            const setIfExists = (name, value) => {
                const field = createForm.querySelector(`[name="${name}"]`);
                if (field && typeof value !== "undefined") {
                    field.value = value;
                }
            };

            // Drop the basic inputs back where they were
            // Restore basic fields
            [
                "title",
                "date",
                "description",
                "location",
                "start_time",
                "end_time",
                "type",
                "user_id",
            ].forEach((name) => setIfExists(name, state[name]));

            // Tick any genres I already picked
            if (Array.isArray(state.genres)) {
                const selected = state.genres.map((value) => parseInt(value, 10));
                document.querySelectorAll(genreCheckboxSelector).forEach(
                    (checkbox) => {
                        checkbox.checked = selected.includes(
                            parseInt(checkbox.value, 10)
                        );
                    }
                );
            }

            if (Array.isArray(prefilledGenres) && prefilledGenres.length) {
                document.querySelectorAll(genreCheckboxSelector).forEach(
                    (checkbox) => {
                        if (
                            prefilledGenres.includes(
                                parseInt(checkbox.value, 10)
                            )
                        ) {
                            checkbox.checked = true;
                        }
                    }
                );
            }

            // Bring back the artists I added before
            if (Array.isArray(state.artist_name) && artistRows) {
                ensureRowCount(artistRows, state.artist_name.length);
                Array.from(
                    document.querySelectorAll('input[name="artist_name[]"]')
                ).forEach((input, index) => {
                    input.value = state.artist_name[index] || "";
                });
            }

            // Match their set times too
            if (Array.isArray(state.artist_set_time)) {
                Array.from(
                    document.querySelectorAll('input[name="artist_set_time[]"]')
                ).forEach((input, index) => {
                    input.value = state.artist_set_time[index] || "";
                });
            }

            // Rebuild the ticket tiers and drop every saved value back in
            if (ticketRows) {
                const ticketCounts = [
                    Array.isArray(state.ticket_tier)
                        ? state.ticket_tier.length
                        : 0,
                    Array.isArray(state.ticket_price)
                        ? state.ticket_price.length
                        : 0,
                    Array.isArray(state.ticket_quantity)
                        ? state.ticket_quantity.length
                        : 0,
                    Array.isArray(state.ticket_perks)
                        ? state.ticket_perks.length
                        : 0,
                ];
                const desiredTicketCount = Math.max(1, ...ticketCounts);
                ensureTicketBlocks(desiredTicketCount);

                if (Array.isArray(state.ticket_tier)) {
                    Array.from(
                        document.querySelectorAll(
                            'input[name="ticket_tier[]"]'
                        )
                    ).forEach((input, index) => {
                        input.value = state.ticket_tier[index] || "";
                    });
                }

                if (Array.isArray(state.ticket_price)) {
                    Array.from(
                        document.querySelectorAll(
                            'input[name="ticket_price[]"]'
                        )
                    ).forEach((input, index) => {
                        input.value = state.ticket_price[index] || "";
                    });
                }

                if (Array.isArray(state.ticket_quantity)) {
                    Array.from(
                        document.querySelectorAll(
                            'input[name="ticket_quantity[]"]'
                        )
                    ).forEach((input, index) => {
                        input.value = state.ticket_quantity[index] || "";
                    });
                }

                if (Array.isArray(state.ticket_perks)) {
                    Array.from(
                        document.querySelectorAll(
                            'input[name="ticket_perks[]"]'
                        )
                    ).forEach((input, index) => {
                        input.value = state.ticket_perks[index] || "";
                    });
                }

                if (
                    Array.isArray(state.ticket_tier) ||
                    Array.isArray(state.ticket_price) ||
                    Array.isArray(state.ticket_quantity) ||
                    Array.isArray(state.ticket_perks)
                ) {
                    saveState();
                }
            }
        };

    // First thing, see if there is a draft I should reload
        restoreState();

        // Keep any server-provided genres in sync with localStorage
        if (Array.isArray(prefilledGenres) && prefilledGenres.length) {
            let updated = false;
            document.querySelectorAll(genreCheckboxSelector).forEach(
                (checkbox) => {
                    if (
                        prefilledGenres.includes(
                            parseInt(checkbox.value, 10)
                        ) &&
                        !checkbox.checked
                    ) {
                        checkbox.checked = true;
                        updated = true;
                    }
                }
            );
            if (updated) {
                saveState();
            }
        }

        // Save form state on any input or change, clear on submit
        if (createForm) {
            // Anytime I change something, stash it straight away
            createForm.addEventListener("input", saveState);
            createForm.addEventListener("change", saveState);
            createForm.addEventListener("submit", () => {
                // Once the form goes through I want a clean start next time
                localStorage.removeItem(STORAGE_KEY);
            });
        }

        // Let me add another artist while keeping the draft safe
        if (addMoreArtistsBtn && artistRows) {
            addMoreArtistsBtn.addEventListener("click", function () {
                artistRows.appendChild(
                    cloneTemplateRow(artistRows.children[0])
                );
                saveState();
            });
        }

        // Same deal for ticket tiers so everything stays together
        if (addMoreTicketBtn && ticketRows) {
            addMoreTicketBtn.addEventListener("click", function () {
                const fragment = createTicketBlock();
                if (fragment.childNodes.length) {
                    ticketRows.appendChild(fragment);
                    saveState();
                }
            });
        }

        // When I add a genre, record the selection and keep the draft in sync
        if (addGenreForm && selectedGenresField) {
            addGenreForm.addEventListener("submit", () => {
                sessionStorage.setItem(PRESERVE_KEY, "1");
                const checkedValues = Array.from(
                    document.querySelectorAll(genreCheckboxSelector)
                )
                    .filter((checkbox) => checkbox.checked)
                    .map((checkbox) => checkbox.value);
                selectedGenresField.value = checkedValues.join(",");
                saveState();
            });
        }
    });
</script>
{% endblock %}
