{% extends "base.html" %} {% from "partials/search_filters.html" import
render_search_filters %} {% set status_options = ['OPEN', 'INACTIVE', 'SOLD
OUT', 'CANCELLED'] %} {% block body %}

<div class="main-window">
    {{ render_search_filters(search_term=search_term|default(''),
    search_url='events_bp.myevents') }}

    <section class="events-list-page">
        <div class="container" id="events-page-container">
            <!-- prettier-ignore -->
            {% with messages = get_flashed_messages(category_filter=['event_update_success']) %}
                {% if messages %}
            <div class="alert alert-info mt-4" role="alert">
                {% for message in messages %}
                <span>{{ message }}</span>
                {% endfor %}
            </div>
            {% endif %} {% endwith %}

            <!-- My events section -->
            <!-- prettier-ignore -->
            <section class="myevents-section">
                <div class="row align-items-start">
                    {% for event in events %}
                    <div class="col-sm-12 col-md-6 col-lg-4 event-card-column">
                        <div class="window event-card" id="event-{{ event.id }}">
                            <div class="title-bar">
                                <span class="window-title">{{ event.title }}</span>
                                <div class="window-controls">
                                    <button type="button" class="btn" href="#!">_</button>
                                    <button type="button" class="btn" href="#!">☐</button>
                                    <button type="button" class="btn" id="closebtn" href="#!">X</button>
                                </div>
                            </div>
                            <div class="sub-window">
                                <img
                                    src="{{ url_for('static', filename='img/' ~ event.image) if event.image else url_for('static', filename='img/fallback.jpg') }}"
                                    alt="{{ event.title }}"
                                    class="window-img-top img-fit"
                                />

                                <div class="event-display">
                                    <section class="window-tags">
                                        {% set event_type_label = event.event_type.typeName if event.event_type else 'Unassigned' %}
                                        <span class="badge" id="event-type">{{ event_type_label }}</span>
                                        <span class="badge" id="event-status-{{ event.status|lower|replace(' ', '-') }}">{{ event.status }}</span>
                                    </section>

                                    <p class="sub-window-content">
                                        {{ event.description or "Description coming soon." }}
                                        <br /><br />

                                        {% set min_ticket = event.tickets|min(attribute='price') if event.tickets else None %}
                                        <strong>> PRICE:</strong>
                                        {% if min_ticket %}
                                            {% if min_ticket.price == 0 %}
                                                Free Entry
                                            {% else %}
                                                Starting at ${{ '%.2f'|format(min_ticket.price) }}
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        <br />

                                        <strong>> ARTIST LINEUP:</strong>
                                        {% if event.artists %}
                                            {{ event.artists | map(attribute='artistName') | join(', ') }}
                                        {% else %}
                                            TBA
                                        {% endif %}
                                        <br />

                                        <strong>> VENUE:</strong> {{ event.venue.location if event.venue else "TBA" }}
                                        <br />

                                        <strong>> DATE:</strong> {{ event.date or "TBA" }}
                                        <br />

                                        <strong>> TIME:</strong> {{ event.start_time or "TBA" }}{% if event.end_time %}-{{ event.end_time }}{% endif %}
                                        <br />

                                        <strong>> GENRES:</strong>
                                        {% if event.genres %}
                                            {% for g in event.genres %}
                                                <a class="genre-search-link" href="{{ url_for('events_bp.myevents', search=g.genreType) }}">{{ g.genreType }}</a>{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span>N/A</span>
                                        {% endif %}
                                    </p>

                                    <button
                                        type="button"
                                        class="btn start-edit-btn"
                                        data-event-id="{{ event.id }}"
                                    >
                                        Update Event
                                    </button>
                                </div>

                                <!-- Editing events section -->
                                <section class="editing-events-section">
                                <div class="event-edit-form-wrapper d-none">
                                        <div class="image-edit-hint d-none">
                                            Click the poster above to upload a new
                                            image.
                                        </div>
                                    <form
                                        class="event-update-form"
                                        method="post"
                                        action="{{ url_for('events_bp.update_event', event_id=event.id) }}"
                                        enctype="multipart/form-data"
                                    >
                                        <!-- Event Media Section -->
                                        <section class="event-media-section">
                                            <div class="row align-items-center">
                                                <div
                                                    class="col-1"
                                                ></div>
                                                <div class="col-10">
                                                    <div
                                                        class="window"
                                                        id="edit-event-media-window"
                                                    >
                                                        <div class="title-bar">
                                                            <span
                                                                class="window-title"
                                                                >Event
                                                                Media</span
                                                            >
                                                            <div
                                                                class="window-controls"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    _
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    ☐
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    id="closebtn"
                                                                    href="#!"
                                                                >
                                                                    X
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <!-- prettier-ignore -->
                                                        <div class="sub-window">
                                                            <input type="file" class="event-image-input d-none" name="image" accept="image/*" />
                                                            {% set media_items = event.images|sort(attribute='order_index') %}
                                                            {% if media_items %}
                                                            <div class="event-media-edit-section mb-3">
                                                                <p class="text-muted small mb-2">Click an image below to replace it or mark it for deletion.</p>
                                                                <div id="event-media-carousel-{{ event.id }}" class="carousel slide media-edit-carousel" data-bs-interval="false">
                                                                    {% if media_items|length > 1 %}
                                                                    <div class="carousel-indicators">
                                                                        {% for media in media_items %}
                                                                        <button type="button" data-bs-target="#event-media-carousel-{{ event.id }}" data-bs-slide-to="{{ loop.index0 }}" class="{% if loop.first %}active{% endif %}" {% if loop.first %}aria-current="true"{% endif %} aria-label="Slide {{ loop.index }}"></button>
                                                                        {% endfor %}
                                                                    </div>
                                                                    {% endif %}
                                                                    <div class="carousel-inner">
                                                                        {% for media in media_items %}
                                                                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                                                                            <div class="media-edit-item position-relative p-2 border rounded">
                                                                                {% set media_src = url_for('static', filename='img/' ~ media.filename) if media.filename else url_for('static', filename='img/fallback.jpg') %}
                                                                                <img src="{{ media_src }}" class="d-block w-100 img-fit edit-media-preview rounded" alt="{{ event.title }} media {{ loop.index }}" data-original-src="{{ media_src }}" data-input-id="replace-image-{{ media.id }}" />
                                                                                <div class="media-delete-overlay d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-danger bg-opacity-75 text-white fw-semibold rounded">Marked for removal</div>
                                                                                <div class="media-edit-controls mt-2 d-flex gap-2 justify-content-center">
                                                                                    <button type="button" class="btn btn-outline-secondary btn-sm replace-media-btn" data-input-id="replace-image-{{ media.id }}">Replace</button>
                                                                                    <button type="button" class="btn btn-outline-danger btn-sm delete-media-btn" data-checkbox-id="delete-media-{{ media.id }}">Delete</button>
                                                                                </div>
                                                                                <input type="file" class="replace-media-input d-none" id="replace-image-{{ media.id }}" name="replace_image_{{ media.id }}" accept="image/*" />
                                                                                <input type="checkbox" class="delete-media-checkbox d-none" id="delete-media-{{ media.id }}" name="delete_media_ids" value="{{ media.id }}" />
                                                                            </div>
                                                                        </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                    {% if media_items|length > 1 %}
                                                                    <button class="carousel-control-prev" type="button" data-bs-target="#event-media-carousel-{{ event.id }}" data-bs-slide="prev">
                                                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                                        <span class="visually-hidden">Previous</span>
                                                                    </button>
                                                                    <button class="carousel-control-next" type="button" data-bs-target="#event-media-carousel-{{ event.id }}" data-bs-slide="next">
                                                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                                        <span class="visually-hidden">Next</span>
                                                                    </button>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            <div class="mb-3">
                                                                <label class="form-label" for="additional-media-{{ event.id }}">Add New Media</label>
                                                                <input class="form-control additional-media-input" type="file" id="additional-media-{{ event.id }}" name="additional_media" accept="image/*" multiple />
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div
                                                    class="col-1"
                                                ></div>
                                            </div>
                                        </section>
                                        <!-- End of Media Section -->

                                        <!-- Edit Event name section -->
                                        <section class="edit-event-name-section">
                                            <div class="row align-items-center">
                                                <div
                                                    class="col-1"
                                                ></div>
                                                <div
                                                    class="col-10"
                                                >
                                                    <div
                                                        class="window"
                                                        id="edit-event-name-window"
                                                    >
                                                        <div class="title-bar">
                                                            <span
                                                                class="window-title"
                                                                >Event
                                                                Name</span
                                                            >
                                                            <div
                                                                class="window-controls"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    _
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    ☐
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    id="closebtn"
                                                                    href="#!"
                                                                >
                                                                    X
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="sub-window">
                                                                <input
                                                                    type="text"
                                                                    class="form-control form-control-lg"
                                                                    id="title-{{ event.id }}"
                                                                    name="title"
                                                                    value="{{ event.title or '' }}"
                                                                    required
                                                                />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div
                                                    class="col-1"
                                                ></div>
                                            </div>
                                        </section>
                                        <!-- End of Edit Event name section -->

                                        <!-- Edit Event description section -->
                                        <section class="edit-event-description-section">
                                            <div class="row align-items-center">
                                                <div
                                                    class="col-1"
                                                ></div>
                                                <div
                                                    class="col-10"
                                                >
                                                    <div
                                                        class="window"
                                                        id="edit-event-description-window"
                                                    >
                                                        <div class="title-bar">
                                                            <span
                                                                class="window-title"
                                                                >Description</span
                                                            >
                                                            <div
                                                                class="window-controls"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    _
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    ☐
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    id="closebtn"
                                                                    href="#!"
                                                                >
                                                                    X
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="sub-window">
                                                                <label class="form-label" for="description-{{ event.id }}">Description</label>
                                                                <textarea class="form-control" id="description-{{ event.id }}" name="description" rows="4">{{ event.description or '' }}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div
                                                    class="col-1"
                                                ></div>
                                            </div>
                                        </section>
                                        <!-- End of Edit Event description section -->

                                        <!-- Edit Event Location Date Section -->
                                        <section class="edit-event-location-date-section">
                                            <div class="row align-items-center">
                                                <div class="col-1"></div>
                                                <div class="col-4">
                                                    <div
                                                        class="window"
                                                        id="edit-event-location-window"
                                                    >
                                                        <div class="title-bar">
                                                            <span
                                                                class="window-title"
                                                                >Location</span
                                                            >
                                                            <div
                                                                class="window-controls"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    _
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    ☐
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    id="closebtn"
                                                                    href="#!"
                                                                >
                                                                    X
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="sub-window">
                                                            <label class="form-label" for="location-{{ event.id }}">Venue / Location</label>
                                                            <input
                                                                type="text"
                                                                class="form-control"
                                                                id="location-{{ event.id }}"
                                                                name="location"
                                                                value="{{ event.venue.location if event.venue else '' }}"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-2"></div>

                                            <div class="col-4">
                                                <div
                                                    class="window"
                                                    id="edit-event-date-window"
                                                >
                                                    <div class="title-bar">
                                                        <span
                                                            class="window-title"
                                                            >Date</span
                                                        >
                                                        <div
                                                            class="window-controls"
                                                        >
                                                            <button
                                                                type="button"
                                                                class="btn"
                                                                href="#!"
                                                            >
                                                                _
                                                            </button>
                                                            <button
                                                                type="button"
                                                                class="btn"
                                                                href="#!"
                                                            >
                                                                ☐
                                                            </button>
                                                            <button
                                                                type="button"
                                                                class="btn"
                                                                id="closebtn"
                                                                href="#!"
                                                            >
                                                                X
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="sub-window">
                                                        <label
                                                            class="form-label"
                                                            for="date-{{ event.id }}"
                                                            >Date</label
                                                        >
                                                        <input
                                                            type="date"
                                                            class="form-control"
                                                            id="date-{{ event.id }}"
                                                            name="date"
                                                            value="{{ event.date or '' }}"
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1"></div>
                                        </div>
                                        </section>
                                        <!-- End of Edit Event Location Date Section -->

                                        <!-- Edit Event Start End Time Section -->
                                        <section
                                            class="edit-event-start-end-time-section"
                                        >
                                            <div class="row align-items-start">
                                                <div
                                                    class="col-1"
                                                ></div>
                                                <div
                                                    class="col-4"
                                                >
                                                    <div
                                                        class="window"
                                                        id="edit-event-start-time-window"
                                                    >
                                                        <div class="title-bar">
                                                            <span
                                                                class="window-title"
                                                                >Event Start
                                                                Time</span
                                                            >
                                                            <div
                                                                class="window-controls"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    _
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    ☐
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    id="closebtn"
                                                                    href="#!"
                                                                >
                                                                    X
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="sub-window">
                                                            <label
                                                                class="form-label"
                                                                for="start-{{ event.id }}"
                                                                >Start
                                                                Time</label
                                                            >
                                                            <input
                                                                type="time"
                                                                class="form-control"
                                                                id="start-{{ event.id }}"
                                                                name="start_time"
                                                                value="{{ event.start_time or '' }}"
                                                            />
                                                        </div>
                                                    </div>
                                                    {% if form is defined and
                                                    form.start_time and
                                                    form.start_time.errors %}
                                                    <div
                                                        class="alert alert-danger mt-2"
                                                    >
                                                        {% for error in
                                                        form.start_time.errors
                                                        %}{{ error }}<br />{%
                                                        endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-2"></div>
                                                <div
                                                    class="col-4"
                                                >
                                                    <div
                                                        class="window"
                                                        id="edit-event-end-time-window"
                                                    >
                                                        <div class="title-bar">
                                                            <span
                                                                class="window-title"
                                                                >Event End
                                                                Time</span
                                                            >
                                                            <div
                                                                class="window-controls"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    _
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    ☐
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    id="closebtn"
                                                                    href="#!"
                                                                >
                                                                    X
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="sub-window">
                                                            <label
                                                                class="form-label"
                                                                for="end-{{ event.id }}"
                                                                >End Time</label
                                                            >
                                                            <input
                                                                type="time"
                                                                class="form-control"
                                                                id="end-{{ event.id }}"
                                                                name="end_time"
                                                                value="{{ event.end_time or '' }}"
                                                            />
                                                        </div>
                                                        {% if form is defined
                                                        and form.end_time and
                                                        form.end_time.errors %}
                                                        <div
                                                            class="alert alert-danger mt-2"
                                                        >
                                                            {% for error in
                                                            form.end_time.errors
                                                            %}{{ error }}<br />{%
                                                            endfor %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div
                                                    class="col-1"
                                                ></div>
                                            </div>
                                        </section>
                                        <!-- End of Event Enter Start End Time Section -->

                                        <!-- Edit Event Type Section -->
                                        <section class="edit-event-type-section">
                                            <div class="row align-items-start">
                                                <div class="col-1"></div>
                                                <!-- prettier-ignore -->
                                                <div class="col-10">
                                                    <label class="form-label" for="type-{{ event.id }}">Select the type of event.</label>
                                                    <select
                                                        class="form-select"
                                                        id="type-{{ event.id }}"
                                                        name="type"
                                                        required
                                                    >
                                                        <option value="" disabled {% if not event.event_type_id %}selected{% endif %}>
                                                            Select the type of event
                                                        </option>
                                                        {% for type_option in event_type_options %} 
                                                            {% set selected = 'selected' if event.event_type_id == type_option.id else '' %}
                                                            <option value="{{ type_option.id }}" {{ selected }}>
                                                            {{ type_option.typeName }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-1"></div>
                                        </section>
                                        <!-- End of Enter Event Type Section -->

                                        <!-- Event genres section -->
                                        <section
                                            class="edit-event-genres-section"
                                        >
                                            <div class="row align-items-start">
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                                <div
                                                    class="col-sm-12 col-md-8 col-lg-6"
                                                >
                                                    <div
                                                        class="window"
                                                        id="edit-event-genres-window"
                                                    >
                                                        <div class="title-bar">
                                                            <span
                                                                class="window-title"
                                                                >Event
                                                                Genres</span
                                                            >
                                                            <div
                                                                class="window-controls"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    _
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    href="#!"
                                                                >
                                                                    ☐
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    class="btn"
                                                                    id="closebtn"
                                                                    href="#!"
                                                                >
                                                                    X
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="sub-window">
                                                            <!-- prettier-ignore -->
                                                            <label class="form-label" for="genres-{{ event.id }}">Genres</label>
                                                            <select
                                                                class="form-select genres-select"
                                                                id="genres-{{ event.id }}"
                                                                name="genres"
                                                                multiple
                                                                size="6"
                                                                data-event-id="{{ event.id }}"
                                                            >
                                                                {% for genre in
                                                                genre_options %}
                                                                <option
                                                                    value="{{ genre.id }}"
                                                                    {%
                                                                    if
                                                                    genre
                                                                    in
                                                                    event.genres
                                                                    %}selected{%
                                                                    endif
                                                                    %}
                                                                >
                                                                    {{
                                                                    genre.genreType
                                                                    }}
                                                                </option>
                                                                {% endfor %}
                                                            </select>
                                                            <div
                                                                class="form-text"
                                                            >
                                                                Hold Ctrl (or
                                                                Cmd on Mac) to
                                                                select multiple
                                                                genres.
                                                            </div>
                                                            <div class="mt-2">
                                                                <button
                                                                    type="button"
                                                                    class="btn add-genre-btn"
                                                                    data-event-id="{{ event.id }}"
                                                                >
                                                                    + Add Genre
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                            </div>
                                        </section>
                                        <!-- End of event genres section -->

                                        <!-- Event status section -->
                                        <section class="event-status">
                                            <div class="row align-items-start">
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                                <!-- prettier-ignore -->
                                                <div class="col-sm-12 col-md-8 col-lg-6">
                                    <label class="form-label">Status</label>
                                    <div class="d-grid gap-2">
                                        <button
                                            type="button"
                                            class="btn btn-danger btn-lg cancel-event-btn"
                                            data-event-id="{{ event.id }}"
                                        >
                                            Cancel This Event
                                        </button>
                                    </div>
                                    <input
                                        type="hidden"
                                        class="event-status-input"
                                        name="status"
                                        value="{{ event.status }}"
                                        data-original-status="{{ event.status }}"
                                    />
                                    </div>
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                            </div>
                                        </section>
                                        <!-- End of event status section -->

                                        <!-- Enter Event Artist Lineup Section -->
                                        <section class="artist-lineup-section">
                                            <div id="artist-lineup-rows">
                                                <div
                                                    class="row align-items-start artist-row"
                                                >
                                                    <div
                                                        class="col-sm-0 col-md-2 col-lg-3"
                                                    ></div>
                                                    <div
                                                        class="col-sm-12 col-md-4 col-lg-3"
                                                    >
                                                        <div
                                                            class="window"
                                                            id="enter-artist-name-window"
                                                        >
                                                            <div
                                                                class="title-bar"
                                                            >
                                                                <span
                                                                    class="window-title"
                                                                    >Artist
                                                                    Name</span
                                                                >
                                                                <div
                                                                    class="window-controls"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        href="#!"
                                                                    >
                                                                        _
                                                                    </button>
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        href="#!"
                                                                    >
                                                                        ☐
                                                                    </button>
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        id="closebtn"
                                                                        href="#!"
                                                                    >
                                                                        X
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div
                                                                class="sub-window"
                                                            >
                                                                <input
                                                                    class="form-control"
                                                                    type="text"
                                                                    placeholder="Enter artist name"
                                                                    name="artist_name[]"
                                                                />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="col-sm-12 col-md-4 col-lg-3"
                                                    >
                                                        <div
                                                            class="window"
                                                            id="enter-artist-set-time-window"
                                                        >
                                                            <div
                                                                class="title-bar"
                                                            >
                                                                <span
                                                                    class="window-title"
                                                                    >Set
                                                                    Time</span
                                                                >
                                                                <div
                                                                    class="window-controls"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        href="#!"
                                                                    >
                                                                        _
                                                                    </button>
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        href="#!"
                                                                    >
                                                                        ☐
                                                                    </button>
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        id="closebtn"
                                                                        href="#!"
                                                                    >
                                                                        X
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div
                                                                class="sub-window"
                                                            >
                                                                <input
                                                                    class="form-control"
                                                                    type="time"
                                                                    step="60"
                                                                    min="00:00"
                                                                    max="23:59"
                                                                    title="Use 24hr format hh:mm"
                                                                    placeholder="Enter set start time"
                                                                    name="artist_set_time[]"
                                                                />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="col-sm-0 col-md-2 col-lg-3"
                                                    ></div>
                                                </div>
                                            </div>
                                            <div class="row align-items-start">
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                                <div
                                                    class="col-sm-12 col-md-8 col-lg-6"
                                                >
                                                    <div
                                                        class="btn-group"
                                                        id="add-more-artists-btn-group"
                                                    >
                                                        <button
                                                            type="button"
                                                            class="btn btn-primary"
                                                            id="add-more-artists-btn"
                                                        >
                                                            Add more artists...
                                                        </button>
                                                    </div>
                                                </div>
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                            </div>
                                            {% if artist_errors %}
                                            <div class="row mt-2">
                                                <div class="col-3"></div>
                                                <div class="col-6">
                                                    <div
                                                        class="alert alert-danger"
                                                    >
                                                        {% for error in
                                                        artist_errors %}{{ error
                                                        }}<br />{% endfor %}
                                                    </div>
                                                </div>
                                                <div class="col-2"></div>
                                            </div>
                                            {% endif %}
                                        </section>
                                        <!-- End of Artist Lineup Section -->

                                        <!-- Enter Ticket Tiers Section -->
                                        <section class="ticket-tiers-section">
                                            <div id="ticket-tiers-rows">
                                                <div
                                                    class="row align-items-start ticket-row"
                                                >
                                                    <div
                                                        class="col-sm-0 col-md-2 col-lg-3"
                                                    ></div>
                                                    <div
                                                        class="col-sm-12 col-md-8 col-lg-6"
                                                    >
                                                        <div
                                                            class="window"
                                                            id="enter-ticket-tier-window"
                                                        >
                                                            <div
                                                                class="title-bar"
                                                            >
                                                                <span
                                                                    class="window-title"
                                                                    >Ticket
                                                                    Tier</span
                                                                >
                                                                <div
                                                                    class="window-controls"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        href="#!"
                                                                    >
                                                                        _
                                                                    </button>
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        href="#!"
                                                                    >
                                                                        ☐
                                                                    </button>
                                                                    <button
                                                                        type="button"
                                                                        class="btn"
                                                                        id="closebtn"
                                                                        href="#!"
                                                                    >
                                                                        X
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div
                                                                class="sub-window"
                                                            >
                                                                <label
                                                                    class="form-label"
                                                                    >Ticket
                                                                    Tiers</label
                                                                >
                                                                <p
                                                                    class="form-text mb-2"
                                                                >
                                                                    Update
                                                                    pricing,
                                                                    quantity,
                                                                    and perks
                                                                    for each
                                                                    tier.
                                                                </p>
                                                                <div
                                                                    class="ticket-tier-rows"
                                                                    data-event-id="{{ event.id }}"
                                                                >
                                                                    {% for
                                                                    ticket in
                                                                    event.tickets
                                                                    %}
                                                                    <div
                                                                        class="ticket-tier-row border rounded p-3 mb-3"
                                                                        data-ticket-row
                                                                        data-existing="true"
                                                                        data-has-orders="{{ 'true' if ticket.order_links else 'false' }}"
                                                                    >
                                                                        <input
                                                                            type="hidden"
                                                                            name="ticket_row_id[]"
                                                                            value="{{ ticket.id }}"
                                                                        />
                                                                        <input
                                                                            type="hidden"
                                                                            name="ticket_row_delete[]"
                                                                            value="0"
                                                                            class="ticket-row-delete-flag"
                                                                        />
                                                                        <div
                                                                            class="row g-3 align-items-end"
                                                                        >
                                                                            <div
                                                                                class="col-lg-4"
                                                                            >
                                                                                <label
                                                                                    class="form-label"
                                                                                    >Tier
                                                                                    Name</label
                                                                                >
                                                                                <input
                                                                                    type="text"
                                                                                    class="form-control"
                                                                                    name="ticket_row_name[]"
                                                                                    value="{{ ticket.ticketTier }}"
                                                                                    maxlength="100"
                                                                                    required
                                                                                />
                                                                            </div>
                                                                            <div
                                                                                class="col-lg-2 col-md-4"
                                                                            >
                                                                                <label
                                                                                    class="form-label"
                                                                                    >Price
                                                                                    ($)</label
                                                                                >
                                                                                <input
                                                                                    type="number"
                                                                                    class="form-control"
                                                                                    name="ticket_row_price[]"
                                                                                    value="{{ '%.2f'|format(ticket.price) }}"
                                                                                    min="0"
                                                                                    step="0.01"
                                                                                    required
                                                                                />
                                                                            </div>
                                                                            <div
                                                                                class="col-lg-2 col-md-4"
                                                                            >
                                                                                <label
                                                                                    class="form-label"
                                                                                    >Quantity</label
                                                                                >
                                                                                <input
                                                                                    type="number"
                                                                                    class="form-control"
                                                                                    name="ticket_row_quantity[]"
                                                                                    value="{{ ticket.availability }}"
                                                                                    min="0"
                                                                                    step="1"
                                                                                    required
                                                                                />
                                                                            </div>
                                                                            <div
                                                                                class="col-lg-3 col-md-4"
                                                                            >
                                                                                <label
                                                                                    class="form-label"
                                                                                    >Perks</label
                                                                                >
                                                                                <input
                                                                                    type="text"
                                                                                    class="form-control"
                                                                                    name="ticket_row_perks[]"
                                                                                    value="{{ ticket.perks or '' }}"
                                                                                    maxlength="50"
                                                                                />
                                                                            </div>
                                                                            <div
                                                                                class="col-lg-1 col-md-12"
                                                                            >
                                                                                <button
                                                                                    type="button"
                                                                                    class="btn btn-outline-danger w-100 ticket-tier-remove-btn"
                                                                                >
                                                                                    Remove
                                                                                    Tier
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div
                                                                            class="ticket-row-removed-note text-danger small mt-2 d-none"
                                                                        >
                                                                            This
                                                                            tier
                                                                            will
                                                                            be
                                                                            removed
                                                                            when
                                                                            you
                                                                            save.{%
                                                                            if
                                                                            ticket.order_links
                                                                            %}
                                                                            Existing
                                                                            orders
                                                                            will
                                                                            be
                                                                            refunded
                                                                            automatically.{%
                                                                            endif
                                                                            %}
                                                                        </div>
                                                                    </div>
                                                                    {% endfor %}
                                                                </div>
                                                                <div
                                                                    class="d-flex flex-wrap gap-2 mt-2"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="btn btn-outline-primary add-ticket-tier-btn"
                                                                    >
                                                                        + Add
                                                                        Ticket
                                                                        Tier
                                                                    </button>
                                                                </div>
                                                                <!-- Template row so the JS can clone fresh tiers on demand -->
                                                                <template
                                                                    class="ticket-tier-row-template"
                                                                    ><div
                                                                        class="ticket-tier-row border rounded p-3 mb-3"
                                                                        data-ticket-row
                                                                        data-existing="false"
                                                                        data-has-orders="false"
                                                                    >
                                                                        <input
                                                                            type="hidden"
                                                                            name="ticket_row_id[]"
                                                                            value=""
                                                                        />
                                                                        <input
                                                                            type="hidden"
                                                                            name="ticket_row_delete[]"
                                                                            value="0"
                                                                            class="ticket-row-delete-flag"
                                                                        />
                                                                        <div
                                                                            class="row g-3 align-items-end"
                                                                        >
                                                                            <div
                                                                                class="col-lg-4"
                                                                            >
                                                                                <label
                                                                                    class="form-label"
                                                                                    >Tier
                                                                                    Name</label
                                                                                >
                                                                                <input
                                                                                    type="text"
                                                                                    class="form-control"
                                                                                    name="ticket_row_name[]"
                                                                                    maxlength="100"
                                                                                    required
                                                                                />
                                                                            </div>
                                                                            <div
                                                                                class="col-lg-2 col-md-4"
                                                                            >
                                                                                <label
                                                                                    class="form-label"
                                                                                    >Price
                                                                                    ($)</label
                                                                                >
                                                                                <input
                                                                                    type="number"
                                                                                    class="form-control"
                                                                                    name="ticket_row_price[]"
                                                                                    min="0"
                                                                                    step="0.01"
                                                                                    required
                                                                                />
                                                                            </div>
                                                                            <div
                                                                                class="col-lg-2 col-md-4"
                                                                            >
                                                                                <label
                                                                                    class="form-label"
                                                                                    >Quantity</label
                                                                                >
                                                                                <input
                                                                                    type="number"
                                                                                    class="form-control"
                                                                                    name="ticket_row_quantity[]"
                                                                                    min="0"
                                                                                    step="1"
                                                                                    required
                                                                                />
                                                                            </div>
                                                                            <div
                                                                                class="col-lg-3 col-md-4"
                                                                            >
                                                                                <label
                                                                                    class="form-label"
                                                                                    >Perks</label
                                                                                >
                                                                                <input
                                                                                    type="text"
                                                                                    class="form-control"
                                                                                    name="ticket_row_perks[]"
                                                                                    maxlength="50"
                                                                                />
                                                                            </div>
                                                                            <div
                                                                                class="col-lg-1 col-md-12"
                                                                            >
                                                                                <button
                                                                                    type="button"
                                                                                    class="btn btn-outline-danger w-100 ticket-tier-remove-btn"
                                                                                >
                                                                                    Remove
                                                                                    Tier
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div
                                                                            class="ticket-row-removed-note text-danger small mt-2 d-none"
                                                                        >
                                                                            This
                                                                            tier
                                                                            will
                                                                            be
                                                                            removed
                                                                            when
                                                                            you
                                                                            save.
                                                                        </div>
                                                                    </div></template
                                                                >
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="col-sm-0 col-md-2 col-lg-3"
                                                    ></div>
                                                </div>
                                            </div>
                                            <div class="row align-items-start">
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                                <div
                                                    class="col-sm-12 col-md-8 col-lg-6"
                                                >
                                                    <div
                                                        class="btn-group"
                                                        id="add-more-ticket-tiers-btn-group"
                                                    >
                                                        <button
                                                            type="button"
                                                            class="btn btn-primary"
                                                            id="add-more-ticket-tiers-btn"
                                                        >
                                                            Add More Ticket
                                                            Tiers...
                                                        </button>
                                                    </div>
                                                </div>
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                            </div>
                                        </section>
                                        <!-- End of Ticket Tiers Section -->

                                        <!-- Post Event Section -->
                                        <section class="post-event-section">
                                            <div class="row align-items-start">
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                                <div
                                                    class="col-sm-12 col-md-8 col-lg-6"
                                                >
                                                    <div
                                                        class="btn-group"
                                                        id="post-event-btn-group"
                                                    >
                                                        <button
                                                            type="submit"
                                                            class="btn btn-primary"
                                                        >
                                                            Save Changes
                                                        </button>
                                                        <button
                                                            type="button"
                                                            class="btn btn-secondary cancel-edit-btn"
                                                            data-event-id="{{ event.id }}"
                                                        >
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </div>
                                                <div
                                                    class="col-sm-0 col-md-2 col-lg-3"
                                                ></div>
                                            </div>
                                        </section>
                                        <!-- End of Post Event Section -->
                                    </form>
                                </div>
                                </section>
                                <!-- End of Editing events section -->
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12">
                        <div class="window">
                            <div class="sub-window">
                                <p class="sub-window-content">
                                    {% if search_term %}No terms matched your
                                    search.{% else %}You have not created any
                                    events yet.{% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
    </section>
</div>

<script>
    // Main controller so the inline editor actually feels like a proper mini-dashboard
    document.addEventListener("DOMContentLoaded", function () {
        const genreCreateUrl = "{{ url_for('events_bp.create_genre') }}";
        const cardColumns = document.querySelectorAll(".event-card-column");
        const eventRow = document.querySelector(
            ".events-list-page .row.align-items-start"
        );

        // Hang on to the starting order so I can snap cards back into place after edits
        if (eventRow) {
            Array.from(eventRow.children).forEach(function (column, index) {
                if (column.classList.contains("event-card-column")) {
                    column.dataset.originalIndex = index;
                }
            });
        }

        // Restore the pre-edit layout once I close out of edit mode
        function restoreOriginalOrder() {
            if (!eventRow) {
                return;
            }
            const sortedColumns = Array.from(eventRow.children)
                .filter(function (child) {
                    return (
                        child.classList &&
                        child.classList.contains("event-card-column")
                    );
                })
                .sort(function (a, b) {
                    return (
                        Number(a.dataset.originalIndex || 0) -
                        Number(b.dataset.originalIndex || 0)
                    );
                });
            sortedColumns.forEach(function (column) {
                eventRow.appendChild(column);
            });
        }

        // Make the currently edited card jump to the top so it’s easier to focus on
        function moveColumnToFirst(column) {
            if (!eventRow || !column) {
                return;
            }
            eventRow.insertBefore(column, eventRow.firstElementChild);
        }

        // Blow away any inline changes when I bail out of edit mode
        function clearEditingState() {
            restoreOriginalOrder();
            cardColumns.forEach(function (column) {
                column.classList.remove("editing-active");
                const card = column.querySelector(".event-card");
                if (!card) {
                    return;
                }
                card.classList.remove("editing");
                const display = card.querySelector(".event-display");
                const editWrapper = card.querySelector(
                    ".event-edit-form-wrapper"
                );
                if (display && editWrapper) {
                    display.classList.remove("d-none");
                    editWrapper.classList.add("d-none");
                }
                const hint = column.querySelector(".image-edit-hint");
                if (hint) {
                    hint.classList.add("d-none");
                }
                const image = column.querySelector(".window-img-top");
                if (image) {
                    if (image.dataset.originalSrc) {
                        image.src = image.dataset.originalSrc;
                    }
                    image.classList.remove("image-editable-active");
                }
                const imageInput = column.querySelector(".event-image-input");
                if (imageInput) {
                    imageInput.value = "";
                }
                column
                    .querySelectorAll(".media-edit-item")
                    .forEach(function (item) {
                        const preview = item.querySelector(
                            ".edit-media-preview"
                        );
                        if (preview && preview.dataset.originalSrc) {
                            preview.src = preview.dataset.originalSrc;
                        }
                        const fileInput = item.querySelector(
                            ".replace-media-input"
                        );
                        if (fileInput) {
                            fileInput.value = "";
                        }
                        const deleteCheckbox = item.querySelector(
                            ".delete-media-checkbox"
                        );
                        if (deleteCheckbox) {
                            deleteCheckbox.checked = false;
                        }
                        const deleteOverlay = item.querySelector(
                            ".media-delete-overlay"
                        );
                        if (deleteOverlay) {
                            deleteOverlay.classList.add("d-none");
                        }
                        const deleteBtn =
                            item.querySelector(".delete-media-btn");
                        if (deleteBtn) {
                            deleteBtn.textContent = "Delete";
                        }
                        item.classList.remove("marked-for-deletion");
                    });
                const ticketRowsContainer =
                    card.querySelector(".ticket-tier-rows");
                if (ticketRowsContainer) {
                    // Undo any soft deletes and throw away unsaved rows so the card looks clean next time
                    ticketRowsContainer
                        .querySelectorAll("[data-ticket-row]")
                        .forEach(function (row) {
                            const deleteFlag = row.querySelector(
                                ".ticket-row-delete-flag"
                            );
                            const removeBtn = row.querySelector(
                                ".ticket-tier-remove-btn"
                            );
                            const removalNote = row.querySelector(
                                ".ticket-row-removed-note"
                            );
                            const isExisting = row.dataset.existing === "true";
                            if (isExisting) {
                                if (deleteFlag) {
                                    deleteFlag.value = "0";
                                }
                                row.classList.remove(
                                    "ticket-row-deleted",
                                    "opacity-50"
                                );
                                if (removalNote) {
                                    if (removalNote.dataset.defaultText) {
                                        removalNote.textContent =
                                            removalNote.dataset.defaultText;
                                    }
                                    removalNote.classList.add("d-none");
                                }
                                if (removeBtn) {
                                    removeBtn.textContent = "Remove Tier";
                                }
                                row.querySelectorAll("input, textarea").forEach(
                                    function (input) {
                                        if (
                                            input.classList.contains(
                                                "ticket-row-delete-flag"
                                            ) ||
                                            input.type === "hidden" ||
                                            input.name === "ticket_row_id[]"
                                        ) {
                                            return;
                                        }
                                        input.removeAttribute("readonly");
                                    }
                                );
                            } else {
                                row.remove();
                            }
                        });
                }
                const additionalInput = column.querySelector(
                    ".additional-media-input"
                );
                if (additionalInput) {
                    additionalInput.value = "";
                }
                const statusInput = card.querySelector(".event-status-input");
                if (
                    statusInput &&
                    statusInput.dataset.originalStatus !== undefined
                ) {
                    statusInput.value = statusInput.dataset.originalStatus;
                }
            });
        }

        // Hook the poster image up so clicking it opens the hidden file picker
        function setupImagePicker(card) {
            const image = card.querySelector(".window-img-top");
            const input = card.querySelector(".event-image-input");
            const hint = card.querySelector(".image-edit-hint");

            if (!image || !input) {
                return;
            }

            if (!image.dataset.originalSrc) {
                image.dataset.originalSrc = image.src;
            }

            if (hint) {
                hint.classList.remove("d-none");
            }

            if (!image.dataset.bindImagePicker) {
                image.addEventListener("click", function () {
                    if (card.classList.contains("editing")) {
                        input.click();
                    }
                });

                input.addEventListener("change", function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            image.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        image.classList.add("image-editable-active");
                    } else {
                        image.src = image.dataset.originalSrc || image.src;
                        image.classList.remove("image-editable-active");
                    }
                });

                image.dataset.bindImagePicker = "true";
                image.classList.add("image-editable");
            }
        }

        // Wire up the carousel thumbnails with replace/delete actions so media edits stick
        function setupMediaCarousel(card) {
            if (card.dataset.mediaBound === "true") {
                return;
            }

            const mediaItems = card.querySelectorAll(".media-edit-item");
            if (!mediaItems.length) {
                card.dataset.mediaBound = "true";
                return;
            }

            mediaItems.forEach(function (item) {
                const preview = item.querySelector(".edit-media-preview");
                const fileInput = item.querySelector(".replace-media-input");
                const replaceBtn = item.querySelector(".replace-media-btn");
                const deleteBtn = item.querySelector(".delete-media-btn");
                const deleteCheckbox = item.querySelector(
                    ".delete-media-checkbox"
                );
                const deleteOverlay = item.querySelector(
                    ".media-delete-overlay"
                );

                if (preview && !preview.dataset.originalSrc) {
                    preview.dataset.originalSrc = preview.getAttribute("src");
                }

                // Show or hide the delete overlay and keep form inputs in sync
                function toggleDeleteState(active) {
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = active;
                    }
                    if (deleteBtn) {
                        deleteBtn.textContent = active
                            ? "Undo Delete"
                            : "Delete";
                    }
                    if (deleteOverlay) {
                        deleteOverlay.classList.toggle("d-none", !active);
                    }
                    item.classList.toggle("marked-for-deletion", active);
                    if (active && fileInput) {
                        fileInput.value = "";
                    }
                    if (active && preview && preview.dataset.originalSrc) {
                        preview.src = preview.dataset.originalSrc;
                    }
                }

                // Route clicks from the preview or button to the hidden file input
                function openFilePicker() {
                    if (card.classList.contains("editing") && fileInput) {
                        fileInput.click();
                    }
                }

                if (preview) {
                    preview.addEventListener("click", openFilePicker);
                }
                if (replaceBtn) {
                    replaceBtn.addEventListener("click", openFilePicker);
                }
                if (fileInput) {
                    fileInput.addEventListener("change", function (event) {
                        const file = event.target.files[0];
                        if (file && preview) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                preview.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                            toggleDeleteState(false);
                        } else if (preview && preview.dataset.originalSrc) {
                            preview.src = preview.dataset.originalSrc;
                        }
                    });
                }
                if (deleteBtn) {
                    deleteBtn.addEventListener("click", function () {
                        const shouldDelete = !(
                            deleteCheckbox && deleteCheckbox.checked
                        );
                        toggleDeleteState(shouldDelete);
                    });
                }
            });

            card.dataset.mediaBound = "true";
        }

        // Glue that keeps the ticket tier mini-form feeling snappy and undo-friendly
        function setupTicketRows(card) {
            if (!card || card.dataset.ticketRowsBound === "true") {
                return;
            }

            const rowsContainer = card.querySelector(".ticket-tier-rows");
            const addButton = card.querySelector(".add-ticket-tier-btn");
            const template = card.querySelector(".ticket-tier-row-template");

            if (!rowsContainer) {
                card.dataset.ticketRowsBound = "true";
                return;
            }

            // Toggle the deleted state so I can undo without losing whatever was typed
            function setRowDeletedState(row, shouldDelete) {
                const deleteFlag = row.querySelector(".ticket-row-delete-flag");
                const removeBtn = row.querySelector(".ticket-tier-remove-btn");
                const removalNote = row.querySelector(
                    ".ticket-row-removed-note"
                );
                if (deleteFlag) {
                    deleteFlag.value = shouldDelete ? "1" : "0";
                }
                row.classList.toggle("ticket-row-deleted", shouldDelete);
                row.classList.toggle("opacity-50", shouldDelete);
                if (removalNote) {
                    const defaultText =
                        removalNote.dataset.defaultText ||
                        removalNote.textContent.trim();
                    removalNote.dataset.defaultText = defaultText;
                    if (shouldDelete && row.dataset.hasOrders === "true") {
                        removalNote.textContent =
                            "This tier will be removed when you save. Existing orders will be refunded automatically.";
                    } else {
                        removalNote.textContent = defaultText;
                    }
                    removalNote.classList.toggle("d-none", !shouldDelete);
                }
                if (removeBtn) {
                    removeBtn.textContent = shouldDelete
                        ? "Undo Remove"
                        : "Remove Tier";
                }
                row.querySelectorAll("input, textarea").forEach(function (
                    input
                ) {
                    if (
                        input.classList.contains("ticket-row-delete-flag") ||
                        input.type === "hidden" ||
                        input.name === "ticket_row_id[]"
                    ) {
                        return;
                    }
                    if (shouldDelete) {
                        input.setAttribute("readonly", "readonly");
                    } else {
                        input.removeAttribute("readonly");
                    }
                });
            }

            // Bind a single row (existing or freshly cloned) with the remove button behavior
            function bindRow(row) {
                if (!row || row.dataset.ticketRowBound === "true") {
                    return;
                }
                const removeBtn = row.querySelector(".ticket-tier-remove-btn");
                const removalNote = row.querySelector(
                    ".ticket-row-removed-note"
                );
                if (removalNote && !removalNote.dataset.defaultText) {
                    removalNote.dataset.defaultText =
                        removalNote.textContent.trim();
                }
                if (removeBtn) {
                    removeBtn.addEventListener("click", function () {
                        const isExisting = row.dataset.existing === "true";
                        const hasOrders = row.dataset.hasOrders === "true";
                        if (isExisting) {
                            const currentlyDeleted =
                                row.classList.contains("ticket-row-deleted");
                            if (!currentlyDeleted && hasOrders) {
                                // Give myself a heads-up before nuking a tier that's already sold tickets
                                const confirmed = window.confirm(
                                    "Removing this tier will trigger refunds for existing orders. Continue?"
                                );
                                if (!confirmed) {
                                    return;
                                }
                            }
                            setRowDeletedState(row, !currentlyDeleted);
                        } else {
                            row.remove();
                        }
                    });
                }
                row.dataset.ticketRowBound = "true";
            }

            rowsContainer
                .querySelectorAll("[data-ticket-row]")
                .forEach(bindRow);

            if (addButton && template) {
                // Clone the template whenever I need a brand new tier row
                addButton.addEventListener("click", function () {
                    const fragment = template.content.cloneNode(true);
                    const newRow = fragment.querySelector("[data-ticket-row]");
                    if (!newRow) {
                        return;
                    }
                    rowsContainer.appendChild(newRow);
                    bindRow(newRow);
                });
            }

            card.dataset.ticketRowsBound = "true";
        }

        // Kick off edit mode when the Update Event button is pressed
        document.querySelectorAll(".start-edit-btn").forEach(function (button) {
            button.addEventListener("click", function () {
                clearEditingState();
                const column = button.closest(".event-card-column");
                const card = button.closest(".event-card");
                if (!column || !card) {
                    return;
                }
                const display = card.querySelector(".event-display");
                const editWrapper = card.querySelector(
                    ".event-edit-form-wrapper"
                );
                if (!display || !editWrapper) {
                    return;
                }
                moveColumnToFirst(column);
                setupImagePicker(card);
                setupMediaCarousel(card);
                // Make sure the ticket tier widgets are interactive the moment edit mode loads
                setupTicketRows(card);
                column.classList.add("editing-active");
                card.classList.add("editing");
                display.classList.add("d-none");
                editWrapper.classList.remove("d-none");
                const image = card.querySelector(".window-img-top");
                if (image) {
                    image.classList.add("image-editable-active");
                }
                column.scrollIntoView({ behavior: "smooth", block: "start" });
            });
        });

        // If I panic halfway through edits, this flips everything back to display mode
        document
            .querySelectorAll(".cancel-edit-btn")
            .forEach(function (button) {
                button.addEventListener("click", function () {
                    clearEditingState();
                });
            });

        // Hard cancel button so I can pull the plug with a quick confirm prompt
        document
            .querySelectorAll(".cancel-event-btn")
            .forEach(function (button) {
                button.addEventListener("click", function () {
                    const column = button.closest(".event-card-column");
                    const form = column
                        ? column.querySelector(".event-update-form")
                        : null;
                    const statusInput = form
                        ? form.querySelector(".event-status-input")
                        : null;
                    if (!form || !statusInput) {
                        return;
                    }
                    const confirmed = window.confirm(
                        "Are you sure you want to cancel this event? This action cannot be undone."
                    );
                    if (!confirmed) {
                        statusInput.value =
                            statusInput.dataset.originalStatus ||
                            statusInput.value;
                        return;
                    }
                    statusInput.value = "CANCELLED";
                    form.submit();
                });
            });

        // Inline genre creator so I can slot in new tags without leaving the page
        document.querySelectorAll(".add-genre-btn").forEach(function (button) {
            button.addEventListener("click", function () {
                const column = button.closest(".event-card-column");
                const activeSelect = column
                    ? column.querySelector(".genres-select")
                    : null;
                const rawInput = window.prompt("Enter a new genre name:");

                if (rawInput === null) {
                    return;
                }

                const genreName = rawInput.trim();
                if (!genreName) {
                    window.alert("Please enter a genre name.");
                    return;
                }

                // Hand the new genre to the server and wait for an ID so every select stays in sync
                fetch(genreCreateUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ name: genreName }),
                })
                    .then(function (response) {
                        return response.json().then(function (data) {
                            return { ok: response.ok, data: data };
                        });
                    })
                    .then(function (result) {
                        if (
                            !result.ok ||
                            !result.data ||
                            !result.data.success
                        ) {
                            // Flag whatever came back so the user knows why nothing happened
                            const message =
                                result.data && result.data.message
                                    ? result.data.message
                                    : "Unable to add genre right now.";
                            window.alert(message);
                            return;
                        }

                        document
                            .querySelectorAll(".genres-select")
                            .forEach(function (selectEl) {
                                const shouldSelect = selectEl === activeSelect;
                                addGenreOptionToSelect(
                                    selectEl,
                                    String(result.data.id),
                                    result.data.name,
                                    shouldSelect
                                );
                            });
                    })
                    .catch(function () {
                        window.alert("Unable to add genre right now.");
                    });
            });
        });
    });

    // Utility that drops a new genre option into any select and sorts it like I manually would
    function addGenreOptionToSelect(
        selectEl,
        genreId,
        genreName,
        shouldSelect
    ) {
        if (!selectEl) {
            return;
        }

        const existingOption = Array.from(selectEl.options).find(function (
            option
        ) {
            return option.value === genreId;
        });

        if (existingOption) {
            if (shouldSelect) {
                existingOption.selected = true;
            }
            return;
        }

        const newOption = document.createElement("option");
        newOption.value = genreId;
        newOption.textContent = genreName;
        if (shouldSelect) {
            newOption.selected = true;
        }

        const options = Array.from(selectEl.options);
        // Keep the list alphabetical so it doesn’t feel random across different events
        const insertIndex = options.findIndex(function (option) {
            return (
                option.text.localeCompare(genreName, undefined, {
                    sensitivity: "base",
                }) > 0
            );
        });

        if (insertIndex >= 0) {
            selectEl.add(newOption, options[insertIndex]);
        } else {
            selectEl.add(newOption);
        }
    }
</script>
{% endblock %}
