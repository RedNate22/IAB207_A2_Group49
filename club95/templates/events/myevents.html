{% extends "base.html" %}
{% from "partials/search_filters.html" import render_search_filters %}
{% set status_options = ['OPEN', 'INACTIVE', 'SOLD OUT', 'CANCELLED'] %}
{% block body %}

<div class="main-window">
    {{ render_search_filters(search_term=search_term|default(''), search_url='events_bp.myevents') }}

    <section class="events-list-page">
        <div class="container" id="events-page-container">

            {% with messages = get_flashed_messages(category_filter=['event_update_success']) %}
                {% if messages %}
                    <div class="alert alert-info mt-4" role="alert">
                        {% for message in messages %}
                            <span>{{ message }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <div class="row align-items-start gy-4">
                {% for event in events %}
                <div class="col-sm-12 col-md-6 col-lg-4 event-card-column">
                    <div class="window event-card" id="event-{{ event.id }}">
                        <div class="title-bar">
                            <span class="window-title">{{ event.title }}</span>
                            <div class="window-controls">
                                <button type="button" class="btn" href="#!">_</button>
                                <button type="button" class="btn" href="#!">‚òê</button>
                                <button type="button" class="btn" id="closebtn" href="#!">X</button>
                            </div>
                        </div>
                        <div class="sub-window">
                            <img
                                src="{{ url_for('static', filename='img/' ~ event.image) if event.image else url_for('static', filename='img/fallback.jpg') }}"
                                alt="{{ event.title }}"
                                class="window-img-top img-fit"
                            />

                            <div class="event-display">
                                <section class="window-tags">
                                    {% set event_type_label = event.event_type.typeName if event.event_type else 'Unassigned' %}
                                    <span class="badge" id="event-type">{{ event_type_label }}</span>
                                    <span class="badge" id="event-status-{{ event.status|lower|replace(' ', '-') }}">{{ event.status }}</span>
                                </section>

                                <p class="sub-window-content">
                                    {{ event.description or "Description coming soon." }}
                                    <br /><br />

                                    {% set min_ticket = event.tickets|min(attribute='price') if event.tickets else None %}
                                    <strong>> PRICE:</strong>
                                    {% if min_ticket %}
                                        {% if min_ticket.price == 0 %}
                                            Free Entry
                                        {% else %}
                                            Starting at ${{ '%.2f'|format(min_ticket.price) }}
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                    <br />

                                    <strong>> ARTIST LINEUP:</strong>
                                    {% if event.artists %}
                                        {{ event.artists | map(attribute='artistName') | join(', ') }}
                                    {% else %}
                                        TBA
                                    {% endif %}
                                    <br />

                                    <strong>> VENUE:</strong> {{ event.venue.location if event.venue else "TBA" }}
                                    <br />

                                    <strong>> DATE:</strong> {{ event.date or "TBA" }}
                                    <br />

                                    <strong>> TIME:</strong> {{ event.start_time or "TBA" }}{% if event.end_time %}-{{ event.end_time }}{% endif %}
                                    <br />

                                    <strong>> GENRES:</strong>
                                    {% if event.genres %}
                                        {% for g in event.genres %}
                                            <a href="#!">{{ g.genreType }}</a>{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span>N/A</span>
                                    {% endif %}
                                </p>

                                <button type="button" class="btn start-edit-btn" data-event-id="{{ event.id }}">
                                    Update Event
                                </button>
                            </div>

                            <div class="event-edit-form-wrapper d-none">
                                <div class="image-edit-hint d-none">Click the poster above to upload a new image.</div>
                                <form class="event-update-form" method="post" action="{{ url_for('events_bp.update_event', event_id=event.id) }}" enctype="multipart/form-data">
                                    <input type="file" class="event-image-input d-none" name="image" accept="image/*" />
                                    {% set media_items = event.images|sort(attribute='order_index') %}
                                    {% if media_items %}
                                    <div class="event-media-edit-section mb-3">
                                        <p class="text-muted small mb-2">Click an image below to replace it or mark it for deletion.</p>
                                        <div id="event-media-carousel-{{ event.id }}" class="carousel slide media-edit-carousel" data-bs-interval="false">
                                            {% if media_items|length > 1 %}
                                            <div class="carousel-indicators">
                                                {% for media in media_items %}
                                                <button type="button" data-bs-target="#event-media-carousel-{{ event.id }}" data-bs-slide-to="{{ loop.index0 }}" class="{% if loop.first %}active{% endif %}" {% if loop.first %}aria-current="true"{% endif %} aria-label="Slide {{ loop.index }}"></button>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="carousel-inner">
                                                {% for media in media_items %}
                                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                                    <div class="media-edit-item position-relative p-2 border rounded">
                                                        {% set media_src = url_for('static', filename='img/' ~ media.filename) if media.filename else url_for('static', filename='img/fallback.jpg') %}
                                                        <img src="{{ media_src }}" class="d-block w-100 img-fit edit-media-preview rounded" alt="{{ event.title }} media {{ loop.index }}" data-original-src="{{ media_src }}" data-input-id="replace-image-{{ media.id }}" />
                                                        <div class="media-delete-overlay d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-danger bg-opacity-75 text-white fw-semibold rounded">Marked for removal</div>
                                                        <div class="media-edit-controls mt-2 d-flex gap-2 justify-content-center">
                                                            <button type="button" class="btn btn-outline-secondary btn-sm replace-media-btn" data-input-id="replace-image-{{ media.id }}">Replace</button>
                                                            <button type="button" class="btn btn-outline-danger btn-sm delete-media-btn" data-checkbox-id="delete-media-{{ media.id }}">Delete</button>
                                                        </div>
                                                        <input type="file" class="replace-media-input d-none" id="replace-image-{{ media.id }}" name="replace_image_{{ media.id }}" accept="image/*" />
                                                        <input type="checkbox" class="delete-media-checkbox d-none" id="delete-media-{{ media.id }}" name="delete_media_ids" value="{{ media.id }}" />
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% if media_items|length > 1 %}
                                            <button class="carousel-control-prev" type="button" data-bs-target="#event-media-carousel-{{ event.id }}" data-bs-slide="prev">
                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Previous</span>
                                            </button>
                                            <button class="carousel-control-next" type="button" data-bs-target="#event-media-carousel-{{ event.id }}" data-bs-slide="next">
                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Next</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="mb-3">
                                        <label class="form-label" for="additional-media-{{ event.id }}">Add New Media</label>
                                        <input class="form-control additional-media-input" type="file" id="additional-media-{{ event.id }}" name="additional_media" accept="image/*" multiple />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" for="title-{{ event.id }}">Title</label>
                                        <input type="text" class="form-control" id="title-{{ event.id }}" name="title" value="{{ event.title or '' }}" required />
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="type-{{ event.id }}">Type</label>
                                        <select class="form-select" id="type-{{ event.id }}" name="type" required>
                                            <option value="" disabled {% if not event.event_type_id %}selected{% endif %}>Select an event type</option>
                                            {% for type_option in event_type_options %}
                                                <option value="{{ type_option.id }}" {% if event.event_type_id == type_option.id %}selected{% endif %}>{{ type_option.typeName }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="status-{{ event.id }}">Status</label>
                                        <select class="form-select" id="status-{{ event.id }}" name="status" required>
                                            {% for status_option in status_options %}
                                                <option value="{{ status_option }}" {% if event.status == status_option %}selected{% endif %}>{{ status_option }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="mb-3 genre-toggle-section">
                                        <span class="form-label d-block mb-2">Genres</span>
                                        <div class="genre-toggle-group" data-event-id="{{ event.id }}">
                                            {% for genre in genre_options %}
                                                {% set toggle_id = 'genre-' ~ event.id ~ '-' ~ loop.index %}
                                                <input
                                                    type="checkbox"
                                                    class="btn-check"
                                                    id="{{ toggle_id }}"
                                                    name="genres"
                                                    value="{{ genre.id }}"
                                                    {% if genre in event.genres %}checked{% endif %}
                                                />
                                                <label class="btn genre-toggle" for="{{ toggle_id }}">
                                                    {{ genre.genreType }}
                                                </label>
                                            {% endfor %}
                                        </div>
                                        <div class="genre-toggle-actions">
                                            <button type="button" class="btn add-genre-btn" data-event-id="{{ event.id }}">
                                                + Add Genre
                                            </button>
                                        </div>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label" for="date-{{ event.id }}">Date</label>
                                            <input type="date" class="form-control" id="date-{{ event.id }}" name="date" value="{{ event.date or '' }}" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label" for="start-{{ event.id }}">Start Time</label>
                                            <input type="time" class="form-control" id="start-{{ event.id }}" name="start_time" value="{{ event.start_time or '' }}" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label" for="end-{{ event.id }}">End Time</label>
                                            <input type="time" class="form-control" id="end-{{ event.id }}" name="end_time" value="{{ event.end_time or '' }}" />
                                        </div>
                                    </div>

                                    <div class="mb-3 mt-3">
                                        <label class="form-label" for="location-{{ event.id }}">Venue / Location</label>
                                        <input type="text" class="form-control" id="location-{{ event.id }}" name="location" value="{{ event.venue.location if event.venue else '' }}" />
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="description-{{ event.id }}">Description</label>
                                        <textarea class="form-control" id="description-{{ event.id }}" name="description" rows="4">{{ event.description or '' }}</textarea>
                                    </div>

                                    <div class="d-flex gap-2 flex-wrap">
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                        <button type="button" class="btn btn-secondary cancel-edit-btn" data-event-id="{{ event.id }}">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="window">
                        <div class="sub-window">
                            <p class="sub-window-content">{% if search_term %}No terms matched your search.{% else %}You have not created any events yet.{% endif %}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
</div>

<script>
// Main controller for handling the inline edit state on My Events cards
document.addEventListener('DOMContentLoaded', function () {
    const genreCreateUrl = "{{ url_for('events_bp.create_genre') }}";
    const cardColumns = document.querySelectorAll('.event-card-column');
    const eventRow = document.querySelector('.events-list-page .row.align-items-start');

    // Cache starting column order so edit mode can preserve layout on exit
    if (eventRow) {
        Array.from(eventRow.children).forEach(function (column, index) {
            if (column.classList.contains('event-card-column')) {
                column.dataset.originalIndex = index;
            }
        });
    }

    // Restore cards to their initial ordering after edits finish
    function restoreOriginalOrder() {
        if (!eventRow) {
            return;
        }
        const sortedColumns = Array.from(eventRow.children)
            .filter(function (child) { return child.classList && child.classList.contains('event-card-column'); })
            .sort(function (a, b) {
                return Number(a.dataset.originalIndex || 0) - Number(b.dataset.originalIndex || 0);
            });
        sortedColumns.forEach(function (column) {
            eventRow.appendChild(column);
        });
    }

    // Surface the active edit card at the top of the grid
    function moveColumnToFirst(column) {
        if (!eventRow || !column) {
            return;
        }
        eventRow.insertBefore(column, eventRow.firstElementChild);
    }

    // Reset all controls and previews when leaving edit mode
    function clearEditingState() {
        restoreOriginalOrder();
        cardColumns.forEach(function (column) {
            column.classList.remove('editing-active');
            const card = column.querySelector('.event-card');
            if (!card) {
                return;
            }
            card.classList.remove('editing');
            const display = card.querySelector('.event-display');
            const editWrapper = card.querySelector('.event-edit-form-wrapper');
            if (display && editWrapper) {
                display.classList.remove('d-none');
                editWrapper.classList.add('d-none');
            }
            const hint = column.querySelector('.image-edit-hint');
            if (hint) {
                hint.classList.add('d-none');
            }
            const image = column.querySelector('.window-img-top');
            if (image) {
                if (image.dataset.originalSrc) {
                    image.src = image.dataset.originalSrc;
                }
                image.classList.remove('image-editable-active');
            }
            const imageInput = column.querySelector('.event-image-input');
            if (imageInput) {
                imageInput.value = '';
            }
            column.querySelectorAll('.media-edit-item').forEach(function (item) {
                const preview = item.querySelector('.edit-media-preview');
                if (preview && preview.dataset.originalSrc) {
                    preview.src = preview.dataset.originalSrc;
                }
                const fileInput = item.querySelector('.replace-media-input');
                if (fileInput) {
                    fileInput.value = '';
                }
                const deleteCheckbox = item.querySelector('.delete-media-checkbox');
                if (deleteCheckbox) {
                    deleteCheckbox.checked = false;
                }
                const deleteOverlay = item.querySelector('.media-delete-overlay');
                if (deleteOverlay) {
                    deleteOverlay.classList.add('d-none');
                }
                const deleteBtn = item.querySelector('.delete-media-btn');
                if (deleteBtn) {
                    deleteBtn.textContent = 'Delete';
                }
                item.classList.remove('marked-for-deletion');
            });
            const additionalInput = column.querySelector('.additional-media-input');
            if (additionalInput) {
                additionalInput.value = '';
            }
        });
    }

    // Hook the main poster image up to the hidden file input
    function setupImagePicker(card) {
        const image = card.querySelector('.window-img-top');
        const input = card.querySelector('.event-image-input');
        const hint = card.querySelector('.image-edit-hint');

        if (!image || !input) {
            return;
        }

        if (!image.dataset.originalSrc) {
            image.dataset.originalSrc = image.src;
        }

        if (hint) {
            hint.classList.remove('d-none');
        }

        if (!image.dataset.bindImagePicker) {
            image.addEventListener('click', function () {
                if (card.classList.contains('editing')) {
                    input.click();
                }
            });

            input.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        image.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    image.classList.add('image-editable-active');
                } else {
                    image.src = image.dataset.originalSrc || image.src;
                    image.classList.remove('image-editable-active');
                }
            });

            image.dataset.bindImagePicker = 'true';
            image.classList.add('image-editable');
        }
    }

    // Attach replace/delete behavior to each carousel image slide
    function setupMediaCarousel(card) {
        if (card.dataset.mediaBound === 'true') {
            return;
        }

        const mediaItems = card.querySelectorAll('.media-edit-item');
        if (!mediaItems.length) {
            card.dataset.mediaBound = 'true';
            return;
        }

        mediaItems.forEach(function (item) {
            const preview = item.querySelector('.edit-media-preview');
            const fileInput = item.querySelector('.replace-media-input');
            const replaceBtn = item.querySelector('.replace-media-btn');
            const deleteBtn = item.querySelector('.delete-media-btn');
            const deleteCheckbox = item.querySelector('.delete-media-checkbox');
            const deleteOverlay = item.querySelector('.media-delete-overlay');

            if (preview && !preview.dataset.originalSrc) {
                preview.dataset.originalSrc = preview.getAttribute('src');
            }

            // Show or hide the delete overlay and keep form inputs in sync
            function toggleDeleteState(active) {
                if (deleteCheckbox) {
                    deleteCheckbox.checked = active;
                }
                if (deleteBtn) {
                    deleteBtn.textContent = active ? 'Undo Delete' : 'Delete';
                }
                if (deleteOverlay) {
                    deleteOverlay.classList.toggle('d-none', !active);
                }
                item.classList.toggle('marked-for-deletion', active);
                if (active && fileInput) {
                    fileInput.value = '';
                }
                if (active && preview && preview.dataset.originalSrc) {
                    preview.src = preview.dataset.originalSrc;
                }
            }

            // Route clicks from the preview or button to the hidden file input
            function openFilePicker() {
                if (card.classList.contains('editing') && fileInput) {
                    fileInput.click();
                }
            }

            if (preview) {
                preview.addEventListener('click', openFilePicker);
            }
            if (replaceBtn) {
                replaceBtn.addEventListener('click', openFilePicker);
            }
            if (fileInput) {
                fileInput.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file && preview) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            preview.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        toggleDeleteState(false);
                    } else if (preview && preview.dataset.originalSrc) {
                        preview.src = preview.dataset.originalSrc;
                    }
                });
            }
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function () {
                    const shouldDelete = !(deleteCheckbox && deleteCheckbox.checked);
                    toggleDeleteState(shouldDelete);
                });
            }
        });

        card.dataset.mediaBound = 'true';
    }

    // Kick off edit mode when the Update Event button is pressed
    document.querySelectorAll('.start-edit-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            clearEditingState();
            const column = button.closest('.event-card-column');
            const card = button.closest('.event-card');
            if (!column || !card) {
                return;
            }
            const display = card.querySelector('.event-display');
            const editWrapper = card.querySelector('.event-edit-form-wrapper');
            if (!display || !editWrapper) {
                return;
            }
            moveColumnToFirst(column);
            setupImagePicker(card);
            setupMediaCarousel(card);
            column.classList.add('editing-active');
            card.classList.add('editing');
            display.classList.add('d-none');
            editWrapper.classList.remove('d-none');
            const image = card.querySelector('.window-img-top');
            if (image) {
                image.classList.add('image-editable-active');
            }
            column.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });

    document.querySelectorAll('.cancel-edit-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            clearEditingState();
        });
    });

    function addGenreToggleToGroup(group, genreId, genreName, shouldSelect) {
        if (!group) {
            return;
        }

        const existingInput = group.querySelector('.btn-check[value="' + genreId + '"]');
        if (existingInput) {
            if (shouldSelect) {
                existingInput.checked = true;
            }
            return;
        }

        const toggleCount = group.querySelectorAll('.btn-check').length + 1;
        const eventId = group.dataset.eventId || 'global';
        const toggleId = 'genre-' + eventId + '-' + genreId + '-' + toggleCount;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'btn-check';
        input.id = toggleId;
        input.name = 'genres';
        input.value = genreId;
        if (shouldSelect) {
            input.checked = true;
        }

        const label = document.createElement('label');
        label.className = 'btn genre-toggle';
        label.setAttribute('for', toggleId);
        label.textContent = genreName;

        group.appendChild(input);
        group.appendChild(label);
    }

    document.querySelectorAll('.add-genre-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            const column = button.closest('.event-card-column');
            const activeGroup = column ? column.querySelector('.genre-toggle-group') : null;
            const rawInput = window.prompt('Enter a new genre name:');

            if (rawInput === null) {
                return;
            }

            const genreName = rawInput.trim();
            if (!genreName) {
                window.alert('Please enter a genre name.');
                return;
            }

            fetch(genreCreateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: genreName }),
            })
                .then(function (response) {
                    return response.json().then(function (data) {
                        return { ok: response.ok, data: data };
                    });
                })
                .then(function (result) {
                    if (!result.ok || !result.data || !result.data.success) {
                        const message = (result.data && result.data.message) ? result.data.message : 'Unable to add genre right now.';
                        window.alert(message);
                        return;
                    }

                    document.querySelectorAll('.genre-toggle-group').forEach(function (group) {
                        const shouldSelect = group === activeGroup;
                        addGenreToggleToGroup(group, result.data.id, result.data.name, shouldSelect);
                    });
                })
                .catch(function () {
                    window.alert('Unable to add genre right now.');
                });
        });
    });
});
</script>
{% endblock %}
