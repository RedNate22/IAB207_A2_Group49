{% extends "base.html" %} {% block body %}

<div class="main-window">
    <!-- Event Details page -->
    <!-- The full details of the selected event are listed.
    Different 'sections' of details are split into separate windows. -->
    <section class="event-details-page">
        <!-- Event Details Page Container -->
        <div class="container" id="event-details-page-container">
            <div class="row align-items-center">
                <!-- Event Poster Window -->
                <div class="col-12">
                    <div class="window" id="event-poster-window">
                        <div class="title-bar">
                            <span class="window-title"
                                >Crescent City Players</span
                            >
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <div class="sub-window">
                            <img
                                src="{{ url_for('static', filename='img/crescent-city-players-poster-horizontal.jpg') }}"
                                class="window-img-top img-fit"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <div class="row align-items-start">
                <!-- Event Description Window -->
                <!-- Holds the description, genres, artist lineup and set times (if given) -->
                <div class="col-sm-12 col-md-6">
                    <div class="window" id="event-description-window">
                        <div class="title-bar">
                            <span class="window-title">Description</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <div class="sub-window">
                            <p class="sub-window-content">
                                An intimate evening of smooth jazz and
                                improvisation, featuring local hit talent,
                                Crescent City Players, joined by The Walters and
                                Mojo Webb. Enjoy classic standards and modern
                                tunes in a cozy, relaxed setting.
                                <br />
                                <br />
                                <strong>> ARTIST LINEUP:</strong>
                                Crescent City Players, The Walters and Mojo Webb
                                <br />
                                <strong>> GENRES:</strong>
                                <a href="#!">Jazz</a>, <a href="#!">Swing</a>,
                                <a href="#!">Fusion</a>,
                                <br />
                                <strong>> SET TIMES:</strong>
                                <br />
                                1pm-1:30pm: The Walters and Mojo Webb
                                <br />
                                1:30pm-3pm: Crescent City Players
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Event Venue, Date, & Time Window -->
                <div class="col-sm-12 col-md-6">
                    <div class="window" id="event-venue-date-time-window">
                        <div class="title-bar">
                            <span class="window-title">Venue/Date/Time</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <div class="sub-window">
                            <p class="sub-window-content">
                                <strong>> VENUE:</strong>
                                Royal Mail Hotel (92 Brisbane Terrace Goodna,
                                QLD)
                                <br />
                                <strong>> DATE:</strong>
                                Sept 30, 2025
                                <br />
                                <strong>> TIME:</strong>
                                1pm-3pm
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row align-items-start">
                <!-- Event Tags Window -->
                <div class="col-12 col-md-6">
                    <div class="window" id="event-tags-window">
                        <div class="title-bar">
                            <span class="window-title">Status</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <div class="sub-window">
                            <section class="window-tags">
                                <span class="badge" id="event-type"
                                    >Live Concert</span
                                >
                                <span class="badge" id="event-status-open"
                                    >OPEN</span
                                >
                            </section>
                        </div>
                    </div>

                    <!-- Ticket Tiers Window -->
                    <div class="window" id="ticket-tiers-window">
                        <div class="title-bar">
                            <span class="window-title">Ticket Tiers</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <div class="sub-window">
                            <p class="sub-window-content">
                                <strong>> TIER 1:</strong>
                                Free Entry
                                <br />
                                <strong>> TIER 2:</strong>
                                $7.99 + 1 drink of choice
                                <br />
                                <strong>> TIER 3:</strong>
                                $14.99 + 2 drinks of choice
                                <br />
                                <strong>> TIER 4:</strong>
                                $24.99 + 2 drinks of choice + priority seating
                                <br />
                                <strong>> TIER 5:</strong>
                                $49.99 VIP (unlimited drinks, meet and greet)
                            </p>
                        </div>
                    </div>
                </div>
                <!-- End of Purchase Tickets Button -->

                <!-- Venue Map Window -->
                <div class="col-sm-12 col-md-6">
                    <div class="window" id="venue-map-window">
                        <div class="title-bar">
                            <span class="window-title">Map</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <div class="sub-window">
                            <iframe
                                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d4557.585727553991!2d152.90289687637085!3d-27.60649677624054!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x6b914c092af2ac3d%3A0xdca2f583d78471c7!2sRoyal%20Mail%20Hotel!5e1!3m2!1sen!2sau!4v1757136725190!5m2!1sen!2sau"
                                width="100%"
                                height="100%"
                                style="border: 0"
                                allowfullscreen=""
                                loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade"
                            ></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row align-items-start">
                <!-- Purchase Tickets Button -->
                <div class="col-12">
                    <div class="btn-group" id="purchase-tickets-btn-group">
                        <!-- Button trigger modal -->
                        <button
                            type="button"
                            class="btn btn-primary"
                            id="purchase-tickets-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#purchase-tickets-modal"
                        >
                            Purchase Tickets
                        </button>
                    </div>

                    <div
                        class="modal fade"
                        id="purchase-tickets-modal"
                        tabindex="-1"
                        aria-labelledby="purchase-tickets"
                        aria-hidden="true"
                    >
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <form
                                    id="ticket-selection-form"
                                    method="POST"
                                    action="{{ url_for('events_bp.purchase_tickets', event_id=event.id) }}"
                                >
                                    {{ purchase_form.hidden_tag() }}
                                    <div class="modal-header">
                                        <h1
                                            class="modal-title fs-5"
                                            id="purchase-tickets-title"
                                        >
                                            Purchase Tickets
                                        </h1>
                                        <button
                                            type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"
                                            aria-label="Close"
                                        ></button>
                                    </div>
                                    <div class="modal-body">
                                        <div
                                            class="alert alert-warning d-none"
                                            role="alert"
                                            id="ticket-selection-alert"
                                        >
                                            Select at least one ticket before
                                            continuing.
                                        </div>
                                        {% for ticket in event.tickets %}
                                        <div class="mb-3">
                                            <label
                                                class="form-label"
                                                for="quantity-{{ ticket.id }}"
                                            >
                                                {{ ticket.ticketTier }} – ${{
                                                '%.2f'|format(ticket.price) }}
                                                ({{ ticket.availability }}
                                                available)
                                            </label>
                                            {{ purchase_form['quantity_' ~
                                            ticket.id] }}
                                        </div>
                                        {% else %}
                                        <p class="mb-3">
                                            No ticket tiers are available for
                                            this event.
                                        </p>
                                        {% endfor %}
                                    </div>
                                    <div class="modal-footer">
                                        <button
                                            type="button"
                                            class="btn btn-secondary"
                                            data-bs-dismiss="modal"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-primary"
                                            id="review-order-btn"
                                        >
                                            Review Order
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div
                        class="modal fade"
                        id="confirm-purchase-modal"
                        tabindex="-1"
                        aria-labelledby="confirm-purchase"
                        aria-hidden="true"
                    >
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1
                                        class="modal-title fs-5"
                                        id="confirm-purchase-title"
                                    >
                                        Confirm Order
                                    </h1>
                                    <button
                                        type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                        aria-label="Close"
                                    ></button>
                                </div>
                                <div class="modal-body">
                                    <p class="mb-3">
                                        Please confirm your ticket selection.
                                    </p>
                                    <ul
                                        class="list-group list-group-flush mb-3"
                                        id="order-summary-list"
                                    ></ul>
                                    <p class="fw-bold">
                                        Total: $<span id="order-summary-total"
                                            >0.00</span
                                        >
                                    </p>
                                </div>
                                <div class="modal-footer">
                                    <button
                                        type="button"
                                        class="btn btn-secondary"
                                        data-bs-dismiss="modal"
                                    >
                                        Back
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-primary"
                                        id="confirm-purchase-btn"
                                    >
                                        Confirm Purchase
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shopping cart logic -->
                    <script>
                        document.addEventListener(
                            "DOMContentLoaded",
                            function () {
                                const selectionForm = document.getElementById(
                                    "ticket-selection-form"
                                );
                                const reviewBtn =
                                    document.getElementById("review-order-btn");
                                const confirmModalEl = document.getElementById(
                                    "confirm-purchase-modal"
                                );
                                const summaryList =
                                    document.getElementById(
                                        "order-summary-list"
                                    );
                                const summaryTotalEl = document.getElementById(
                                    "order-summary-total"
                                );
                                const alertBox = document.getElementById(
                                    "ticket-selection-alert"
                                );
                                const confirmBtn = document.getElementById(
                                    "confirm-purchase-btn"
                                );
                                if (!selectionForm || !confirmModalEl) {
                                    return;
                                }

                                let confirmModalInstance = null;

                                reviewBtn?.addEventListener(
                                    "click",
                                    function () {
                                        alertBox?.classList.add("d-none");

                                        const selections = [];
                                        let orderTotal = 0;

                                        selectionForm
                                            .querySelectorAll(
                                                'input[type="number"]'
                                            )
                                            .forEach(function (input) {
                                                const quantity =
                                                    parseInt(input.value, 10) ||
                                                    0;
                                                const price =
                                                    parseFloat(
                                                        input.getAttribute(
                                                            "data-price"
                                                        )
                                                    ) || 0;
                                                const tier =
                                                    input.getAttribute(
                                                        "data-tier"
                                                    ) || "Ticket";

                                                if (quantity > 0) {
                                                    const subtotal =
                                                        quantity * price;
                                                    selections.push({
                                                        tier,
                                                        quantity,
                                                        subtotal,
                                                    });
                                                    orderTotal += subtotal;
                                                }
                                            });

                                        if (selections.length === 0) {
                                            alertBox?.classList.remove(
                                                "d-none"
                                            );
                                            return;
                                        }

                                        if (summaryList) {
                                            summaryList.innerHTML = "";
                                            selections.forEach(function (item) {
                                                const li =
                                                    document.createElement(
                                                        "li"
                                                    );
                                                li.className =
                                                    "list-group-item d-flex justify-content-between align-items-center";
                                                li.innerHTML = `<span>${
                                                    item.tier
                                                } × ${
                                                    item.quantity
                                                }</span><span>$${item.subtotal.toFixed(
                                                    2
                                                )}</span>`;
                                                summaryList.appendChild(li);
                                            });
                                        }

                                        if (summaryTotalEl) {
                                            summaryTotalEl.textContent =
                                                orderTotal.toFixed(2);
                                        }

                                        if (typeof bootstrap !== "undefined") {
                                            if (!confirmModalInstance) {
                                                confirmModalInstance =
                                                    new bootstrap.Modal(
                                                        confirmModalEl
                                                    );
                                            }
                                            confirmModalInstance.show();
                                        }
                                    }
                                );

                                confirmBtn?.addEventListener(
                                    "click",
                                    function () {
                                        selectionForm.submit();
                                    }
                                );
                            }
                        );
                    </script>
                </div>
            </div>

            <div class="row align-items-start">
                <!-- Media Window -->
                <!-- Holds images related to the currently selected event -->
                <!-- (Current images are placeholders) -->
                <div class="col-12">
                    <div class="window" id="event-media-window">
                        <div class="title-bar">
                            <span class="window-title">Media</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <!-- Use a carousel to hold as many images as needed -->
                        <div class="sub-window">
                            <div
                                id="event-media-carousel"
                                class="carousel slide"
                            >
                                <div class="carousel-indicators">
                                    <button
                                        type="button"
                                        data-bs-target="#event-media-carousel"
                                        data-bs-slide-to="0"
                                        class="active"
                                        aria-current="true"
                                        aria-label="Slide 1"
                                    ></button>
                                    <button
                                        type="button"
                                        data-bs-target="#event-media-carousel"
                                        data-bs-slide-to="1"
                                        aria-label="Slide 2"
                                    ></button>
                                    <button
                                        type="button"
                                        data-bs-target="#event-media-carousel"
                                        data-bs-slide-to="2"
                                        aria-label="Slide 3"
                                    ></button>
                                </div>
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img
                                            src="{{ url_for('static', filename='img/jazzband1.jpg') }}"
                                            class="d-block w-100 img-fit"
                                            alt="A saxaphone player in a jazz band performance."
                                        />
                                    </div>
                                    <div class="carousel-item">
                                        <img
                                            src="{{ url_for('static', filename='img/jazzband2.jpg') }}"
                                            class="d-block w-100 img-fit"
                                            alt="The instruments of a band."
                                        />
                                    </div>
                                    <div class="carousel-item">
                                        <img
                                            src="{{ url_for('static', filename='img/bluesbrothers.jpg') }}"
                                            class="d-block w-100 img-fit"
                                            alt="Legendary blues performers, immortalised into statues."
                                        />
                                    </div>
                                </div>
                                <button
                                    class="carousel-control-prev"
                                    type="button"
                                    data-bs-target="#event-media-carousel"
                                    data-bs-slide="prev"
                                >
                                    <span
                                        class="carousel-control-prev-icon"
                                        aria-hidden="true"
                                    ></span>
                                    <span class="visually-hidden"
                                        >Previous</span
                                    >
                                </button>
                                <button
                                    class="carousel-control-next"
                                    type="button"
                                    data-bs-target="#event-media-carousel"
                                    data-bs-slide="next"
                                >
                                    <span
                                        class="carousel-control-next-icon"
                                        aria-hidden="true"
                                    ></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row align-items-center">
                <!-- Add column padding -->
                <div class="col-3"></div>
                <!-- Post Comment Window -->
                <div class="col-sm-12">
                    <div class="window" id="post-comment-window">
                        <div class="title-bar">
                            <span class="window-title">Post a Comment</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <div class="sub-window">
                            <form
                                method="POST"
                                action="{{ url_for('events_bp.add_comment', event_id=event.id) }}"
                            >
                                {{ comment_form.hidden_tag() }}
                                <div class="mb-3" id="post-comment-form">
                                    <label
                                        for="comment-text"
                                        class="enter-comment"
                                    >
                                        Enter comment:
                                    </label>
                                    {{
                                    comment_form.content(class="form-control",
                                    id="comment-text", rows="3") }} {% if
                                    comment_form.content.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ comment_form.content.errors[0] }}
                                    </div>
                                    {% endif %}
                                </div>
                                {{ comment_form.submit(class="btn",
                                id="post-comment-btn") }}
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Add column padding -->
                <div class="col-3"></div>
            </div>

            {% if comments %}
            <div class="row align-items-start">
                <!-- Event Comments Windows -->
                {% for comment in comments %}
                <div class="col-sm-6 col-md-6 col-lg-4">
                    <div class="window" id="event-comments-window">
                        <div class="title-bar">
                            <span class="window-title">Comment</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>

                        <!-- window content -->
                        <div class="sub-window">
                            <p class="sub-window-content">
                                <strong>Poster:</strong>
                                {{ comment.user.name if comment.user and
                                comment.user.name else 'Anonymous' }}
                                <br />
                                <strong>DateTime:</strong>
                                {{ comment.commentDateTime.strftime('%d/%m/%y
                                %H:%M') if comment.commentDateTime else 'N/A' }}
                                <br />
                                <strong>Comment:</strong>
                                {{ comment.content }}
                            </p>
                            <a class="btn" id="reply-to-comment-btn" href="#!">
                                Reply
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="row align-items-start">
                <div class="col-sm-12 col-md-8 col-lg-6">
                    <div class="window" id="event-comments-window">
                        <div class="title-bar">
                            <span class="window-title">Comment</span>
                            <div class="window-controls">
                                <button class="btn">_</button>
                                <button class="btn">☐</button>
                                <button class="btn" id="closebtn">X</button>
                            </div>
                        </div>
                        <div class="sub-window">
                            <p class="sub-window-content">
                                No comments yet. Be the first to share your
                                thoughts!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- End of comments -->
        </div>
        <!-- End of Events Details Container -->
    </section>
    <!-- End of Events Details Section -->
</div>

<!-- Script to sync the height of the Map window to match the combined height
of the Status and Ticket Tiers windows -->
<script>
    //  N: Don't ask how long this took to figure out
    function syncMapHeight() {
        const statusWindow = document.getElementById("event-tags-window");
        const ticketWindow = document.getElementById("ticket-tiers-window");
        const mapWindow = document.getElementById("venue-map-window");

        if (statusWindow && ticketWindow && mapWindow) {
            const ticketStyles = getComputedStyle(ticketWindow);
            const statusStyles = getComputedStyle(statusWindow);

            const combinedHeight =
                // alternatively, .scrollHeight might be better in some situations
                statusWindow.offsetHeight +
                ticketWindow.offsetHeight +
                parseFloat(ticketStyles.marginBottom) +
                parseFloat(ticketStyles.marginTop) +
                parseFloat(statusStyles.marginBottom);

            // Calculate final height
            // N: Had to add 1 extra pixel to fix it, cus I have no clue
            // why there was a tiny gap
            mapWindow.style.height = combinedHeight + 1 + "px";
        }
    }

    window.addEventListener("DOMContentLoaded", syncMapHeight);
    window.addEventListener("resize", syncMapHeight);
</script>
{% endblock %}
